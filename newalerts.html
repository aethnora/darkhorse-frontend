<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkHorse Alerts - Insider & Senator Trade Notifications</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- TradingView Charting Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q8N0PTWEB3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q8N0PTWEB3');
</script>

    <style>
        :root {
            --primary-blue: #0a74da;
            --accent-cyan: #00c6ff;
            --dark-bg: #0a0f1c;
            --card-bg: #10182c;
            --card-bg-glass: rgba(16, 24, 44, 0.7);
            --border-color: rgba(0, 198, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #a0a8b8;
            --text-tertiary: #6b7f99;
            --gradient-primary: linear-gradient(135deg, #0a74da 0%, #00c6ff 100%);
            --success-green: #00ff88;
            --warning-yellow: #ffd700;
            --error-red: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- UTILITY & LAYOUT --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .hidden { display: none !important; }
        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; background: var(--dark-bg); overflow: hidden; }
        .bg-animation::before { content: ''; position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; background: radial-gradient(circle at 20% 50%, rgba(0, 198, 255, 0.15) 0%, transparent 40%), radial-gradient(circle at 80% 80%, rgba(10, 116, 218, 0.15) 0%, transparent 40%); animation: floatAnimation 30s ease-in-out infinite; }
        @keyframes floatAnimation { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(40px, -30px) rotate(5deg); } }

        /* --- BUTTONS & INPUTS --- */
        .btn { display: inline-block; padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: 600; font-size: 1rem; text-align: center; cursor: pointer; transition: all 0.3s ease; border: none; text-decoration: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-primary { background: var(--gradient-primary); color: var(--text-primary); box-shadow: 0 5px 20px rgba(10, 116, 218, 0.3); }
        .btn-primary:not(:disabled):hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 198, 255, 0.4); }
        .btn-secondary { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:not(:disabled):hover { background-color: rgba(0, 198, 255, 0.1); border-color: var(--accent-cyan); }
        .btn-small { padding: 0.4rem 1rem; font-size: 0.8rem; }
        .input-field { width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 0 2px rgba(0, 198, 255, 0.2); }

        /* --- HEADER & AUTH --- */
        .page-header { padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(10, 15, 28, 0.8); backdrop-filter: blur(10px); z-index: 100; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 1.5rem; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .user-controls { display: flex; align-items: center; gap: 1rem; }
        .user-controls .user-email { color: var(--text-secondary); margin-right: 1rem; }
        #loggedInView { display: flex; align-items: center; gap: 1rem; }
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .auth-overlay.show { opacity: 1; pointer-events: auto; }
        .auth-modal { background: var(--card-bg-glass); border-radius: 16px; padding: 2.5rem; width: 90%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); transform: scale(0.95); transition: transform 0.3s ease; }
        .auth-overlay.show .auth-modal { transform: scale(1); }
        .auth-modal h2 { text-align: center; margin-bottom: 2rem; font-size: 2rem; font-weight: 700; }
        .auth-form .form-group { margin-bottom: 1.5rem; }
        .status-message { border-radius: 8px; padding: 0.75rem; font-size: 0.9rem; text-align: center; margin-bottom: 1.5rem; }
        .status-message.error { background: rgba(255, 107, 107, 0.2); border: 1px solid var(--error-red); color: var(--error-red); }
        .status-message.success { background: rgba(0, 255, 136, 0.1); border: 1px solid var(--success-green); color: var(--success-green); }
        .auth-toggle { text-align: center; margin-top: 1.5rem; color: var(--text-secondary); }
        .auth-toggle a { color: var(--accent-cyan); text-decoration: none; font-weight: 600; }

        /* --- PLAN MANAGEMENT STYLES --- */
        #subscriptionInfo { display: flex; align-items: center; gap: 1rem; border: 1px solid var(--border-color); background: var(--card-bg); padding: 0.5rem 1rem; border-radius: 50px; }
        .plan-badge { font-weight: 700; text-transform: capitalize; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.9rem; }
        .plan-badge.professional { color: var(--success-green); background-color: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); }
        .plan-badge.advanced { color: var(--warning-yellow); background-color: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.2); }
        .plan-badge.basic { color: var(--text-secondary); background-color: rgba(160, 168, 184, 0.1); border: 1px solid rgba(160, 168, 184, 0.2); }
        .plan-badge.none { color: var(--text-tertiary); }

        /* --- NEW REVAMPED PRICING SECTION --- */
        .pricing-section .main-title { 
            font-size: 3rem; 
            font-weight: 900; 
            margin-bottom: 1rem; 
            line-height: 1.2;
        }
        .pricing-section .subtitle { 
            font-size: 1.2rem; 
            color: var(--text-secondary); 
            max-width: 650px; 
            margin: 0 auto; 
        }
        .pricing-container {
            background: var(--card-bg-glass);
            backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 3rem;
            display: flex;
            align-items: center;
            gap: 3rem;
            box-shadow: 0 0 50px rgba(0, 198, 255, 0.1), inset 0 0 0 1px rgba(255,255,255,0.05);
            transition: all 0.4s ease;
            max-width: 900px;
            margin: 0 auto;
        }
        @media (max-width: 900px) {
            .pricing-container {
                flex-direction: column;
                padding: 2rem;
                gap: 2rem;
            }
        }
        .pricing-container:hover {
            box-shadow: 0 0 70px rgba(0, 198, 255, 0.2), inset 0 0 0 1px rgba(255,255,255,0.05);
            transform: translateY(-5px);
        }
        .plan-details {
            flex-basis: 40%;
            text-align: center;
            border-right: 1px solid var(--border-color);
            padding-right: 3rem;
        }
        @media (max-width: 900px) {
            .plan-details {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding-right: 0;
                padding-bottom: 2rem;
                width: 100%;
            }
        }
        .plan-details h3 {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        .plan-price {
            font-size: 4rem;
            font-weight: 900;
            line-height: 1;
        }
        .plan-price .period {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .plan-details .btn-primary {
            margin-top: 2rem;
            width: 100%;
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        .plan-features {
            flex-basis: 60%;
        }
        .plan-features h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        .plan-features ul {
            list-style: none;
            margin-bottom: 1.5rem;
        }
        .plan-features li {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }
        .plan-features li i {
            color: var(--success-green);
            font-size: 1.2rem;
        }
        .plan-disclaimer {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        /* --- DASHBOARD LAYOUT --- */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; }
        .dashboard-header h1 { font-size: 2.5rem; }
        .dashboard-tabs { display: flex; gap: 1rem; }
        .tab-btn { background: none; border: none; color: var(--text-secondary); font-size: 1rem; font-weight: 600; padding: 0.5rem 0; cursor: pointer; position: relative; transition: color 0.3s ease; }
        .tab-btn::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--accent-cyan); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-btn.active { color: var(--text-primary); }
        .tab-btn.active::after { transform: scaleX(1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- SETTINGS REVAMP 3.0 --- */
        .settings-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        .settings-header h2 {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .settings-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .settings-split-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            align-items: start;
        }
        @media (max-width: 992px) {
            .settings-split-grid {
                grid-template-columns: 1fr;
            }
        }
        .settings-card { 
            background: var(--card-bg-glass);
            backdrop-filter: blur(12px) saturate(150%);
            border: 1px solid var(--border-color); 
            border-radius: 24px; 
            padding: 2.5rem; 
            height: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2), inset 0 0 0 1px rgba(255,255,255,0.05);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .settings-card::before {
            content: '';
            position: absolute;
            top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(0, 198, 255, 0.1), transparent 40%);
            transform: scale(0);
            transition: transform 0.5s ease-out;
            z-index: -1;
        }
        .settings-card:hover::before {
            transform: scale(1);
        }
        .settings-card h3 { 
            font-size: 1.5rem; 
            font-weight: 700;
            margin-bottom: 2rem; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            color: var(--text-primary);
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .settings-card h3 i { font-size: 1.2rem; color: var(--accent-cyan); }
        .settings-group { margin-bottom: 2.5rem; }
        .settings-group:last-child { margin-bottom: 0; }
        .settings-group .label-text { display: block; margin-bottom: 1rem; font-weight: 600; color: var(--text-secondary); font-size: 1rem; }
        
        .switch-group { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: rgba(0,0,0,0.25); 
            padding: 0.75rem 1rem; 
            border-radius: 12px; 
            border: 1px solid var(--border-color); 
            margin-bottom: 1rem;
        }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--text-tertiary); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-green); }
        input:checked + .slider:before { transform: translateX(22px); }
        
        .multi-select-group { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .multi-select-group label { 
            background: rgba(0,0,0,0.25);
            border-radius: 50px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            border: 1px solid var(--border-color);
        }
        .multi-select-group label:hover span {
            color: var(--accent-cyan);
        }
        .multi-select-group input:checked + span { 
            background: var(--gradient-primary); 
            color: white; 
            box-shadow: 0 2px 10px rgba(0, 198, 255, 0.2);
            border-color: transparent;
        }
        .multi-select-group label span {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .recommended-tag { font-size: 0.8rem; color: var(--warning-yellow); margin-left: 0.5rem; font-weight: 400; }
        .save-settings-container { margin-top: 3rem; text-align: center; }
        .save-settings-container .btn-primary {
            padding: 1rem 3rem;
            font-size: 1.1rem;
        }
        
        /* NEW STYLES FOR SENATOR WATCHLIST */
        .senator-name-highlight {
            color: var(--warning-yellow);
            font-weight: 700;
        }
        .senator-subtext {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-weight: 400;
            margin-top: 2px;
            line-height: 1.2;
        }

        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; margin: 8px 0; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer; animation: 0.2s; background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-cyan) 100%); border-radius: 8px; 
        }
        input[type=range]::-webkit-slider-thumb {
            box-shadow: 0px 0px 5px #000; border: 3px solid var(--dark-bg); height: 24px; width: 24px; border-radius: 50%; background: var(--accent-cyan); cursor: pointer; -webkit-appearance: none; margin-top: -8px;
        }
        input[type=range]::-moz-range-track {
            width: 100%; height: 8px; cursor: pointer; background: linear-gradient(90deg, var(--primary-blue) 0%, var(--accent-cyan) 100%); border-radius: 8px;
        }
        input[type=range]::-moz-range-thumb {
            box-shadow: 0px 0px 5px #000; border: 3px solid var(--dark-bg); height: 24px; width: 24px; border-radius: 50%; background: var(--accent-cyan); cursor: pointer;
        }

        /* --- ENHANCED TRADES FEED & DROPDOWN --- */
        .trades-table { width: 100%; border-collapse: collapse; table-layout: auto; }
        .trades-table th { text-align: left; padding: 1rem; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .trades-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .trades-table tbody tr.trade-row { cursor: pointer; transition: all 0.3s ease; position: relative; }
        .trades-table tbody tr.trade-row:hover { background-color: rgba(0, 198, 255, 0.05); transform: translateY(-1px); }
        .trades-table tr.active-row { 
            background: linear-gradient(90deg, rgba(0, 198, 255, 0.1) 0%, rgba(10, 116, 218, 0.05) 100%) !important; 
            border-left: 3px solid var(--accent-cyan);
            box-shadow: 0 2px 8px rgba(0, 198, 255, 0.1);
        }
        .company-name { font-weight: 600; color: var(--text-primary); }
        .ticker { color: var(--accent-cyan); font-size: 0.9rem; font-weight: 500; }
        .insider-title { color: var(--text-tertiary); font-style: italic; }
        
        /* --- ENHANCED DROPDOWN DESIGN --- */
        .trade-details-row { 
            display: none; 
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        .trade-details-row.active { 
            display: table-row; 
            opacity: 1;
        }
        .trade-details-cell { 
            padding: 0 !important; 
            background: linear-gradient(135deg, rgba(16, 24, 44, 0.95) 0%, rgba(10, 15, 28, 0.95) 100%);
            border-left: 3px solid var(--accent-cyan);
            box-shadow: inset 0 0 20px rgba(0, 198, 255, 0.05);
        }
        .trade-details-content {
            padding: 1rem;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 1rem;
            animation: slideDownFade 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(0, 198, 255, 0.1);
            border-radius: 12px;
            margin: 0.5rem;
            backdrop-filter: blur(10px);
        }
        @media (max-width: 1200px) {
            .trade-details-content { 
                grid-template-columns: 1fr; 
                gap: 1rem;
            }
        }
        @keyframes slideDownFade { 
            0% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.95); 
            } 
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }

        /* --- ADVANCED CHART CONTAINER --- */
        .chart-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            height: fit-content;
        }
        .chart-header {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(0, 198, 255, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .chart-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-header .ticker-badge {
            background: var(--gradient-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .tradingview-widget-container {
            width: 100%;
            height: 450px;
            background: var(--dark-bg);
            position: relative;
        }
        .widget-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .widget-loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- COMPANY PROFILE SECTION --- */
        .profile-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            height: fit-content;
        }
        
        .profile-header {
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(0, 198, 255, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .profile-content {
            padding: 0;
            height: 450px;
        }
        
        .fundamentals-widget {
            width: 100%;
            height: 100%;
            border-radius: 0;
            overflow: hidden;
            background: var(--dark-bg);
        }

        /* --- TOGGLE ICON ENHANCEMENT --- */
        .trade-toggle-icon { 
            margin-left: 0.5rem; 
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .trade-toggle-icon.rotated { 
            transform: rotate(180deg); 
            color: var(--accent-cyan);
        }
        .trade-row:hover .trade-toggle-icon {
            color: var(--accent-cyan);
            transform: translateX(2px);
        }
        .trade-row.active-row:hover .trade-toggle-icon.rotated {
            transform: rotate(180deg) translateX(-2px);
        }

        /* --- SKELETON LOADER --- */
        .skeleton-loader { 
            background: linear-gradient(90deg, var(--card-bg) 25%, var(--text-tertiary) 50%, var(--card-bg) 75%); 
            background-size: 200% 100%; 
            animation: loading 1.5s infinite; 
            border-radius: 4px; 
            color: transparent !important; 
        }
        .skeleton-row td > div { height: 20px; width: 80%; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .feed-container { overflow-x: auto; }

        /* --- REFINED DATE DISPLAY --- */
        .date-cell { width: 120px; }
        .date-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .date-icon-display {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 700;
            width: 60px;
            flex-shrink: 0;
            padding: 4px 0;
        }
        .date-icon-month { display: block; font-size: 0.7rem; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 0.5px; }
        .date-icon-day { display: block; font-size: 1.5rem; line-height: 1.2; color: var(--text-primary); }
        .date-time {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 6px;
            font-style: italic;
        }

        /* --- LOCKED DASHBOARD VIEW --- */
        .locked-dashboard { position: relative; border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; }
        .locked-content { filter: blur(8px); pointer-events: none; }
        .lock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 15, 28, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2rem; }
        .lock-overlay i { font-size: 4rem; color: var(--warning-yellow); margin-bottom: 1.5rem; }
        .lock-overlay h2 { font-size: 2rem; margin-bottom: 1rem; }
        .lock-overlay p { color: var(--text-secondary); margin-bottom: 2rem; max-width: 400px; }
        
        /* --- DISCLAIMER --- */
        .disclaimer { text-align: center; padding: 2rem; font-size: 0.8rem; color: var(--text-tertiary); border-top: 1px solid var(--border-color); margin-top: 4rem; }

        /* --- DEBUG PANEL --- */
        .debug-panel { position: fixed; bottom: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; max-width: 300px; font-size: 0.8rem; z-index: 1000; }
        .debug-panel.hidden { display: none; }
        .debug-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--primary-blue); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 1001; }
    </style>
</head>
<body>

    <div class="bg-animation"></div>

    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()" title="Toggle Debug Panel">
        <i class="fas fa-bug"></i>
    </button>

    <!-- Debug Panel -->
    <div class="debug-panel hidden" id="debugPanel">
        <h4>Debug Info</h4>
        <div id="debugInfo">Loading...</div>
        <button class="btn btn-secondary" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="refreshDebugInfo()">Refresh</button>
    </div>

    <!-- Auth & Processing Modals -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal" id="authModal">
            <h2 id="authTitle">Sign In</h2>
            <form class="auth-form" id="authForm">
                <div class="form-group"> <input type="email" id="email" class="input-field" required placeholder="your@email.com"> </div>
                <div class="form-group"> <input type="password" id="password" class="input-field" required placeholder="••••••••"> </div>
                <div class="status-message error hidden" id="authError"></div>
                <button type="submit" class="btn btn-primary" id="authSubmit">Sign In</button>
            </form>
            <!-- NEW: Google Sign In Button -->
            <div style="text-align: center; color: var(--text-secondary); margin: 1rem 0;">OR</div>
            <button type="button" class="btn btn-secondary" id="googleSignInBtn" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                <img src="https://www.google.com/images/branding/googleg/1x/googleg_standard_color_28dp.png" alt="Google icon" style="width: 20px; height: 20px;">
                Sign In with Google
            </button>
            <!-- END NEW SECTION -->
            <div class="auth-toggle" style="margin-top: 1.5rem;"> <span id="authToggleText">Don't have an account?</span> <a href="#" id="authToggleLink">Sign Up</a> </div>
        </div>
    </div>
    
    <div class="auth-overlay hidden" id="processingOverlay">
        <div class="auth-modal" style="text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--accent-cyan); margin-bottom: 1.5rem;"></i>
            <h2>Finalizing Your Subscription</h2>
            <p class="text-secondary">Please wait a moment while we activate your account...</p>
            <div id="processingProgress" style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-tertiary);"></div>
        </div>
    </div>

    <header class="page-header">
        <div class="logo">DarkHorse</div>
        <div class="user-controls">
            <div id="loggedOutView"> <button class="btn btn-primary" onclick="showAuthModal(false)">Sign In</button> </div>
            <div id="loggedInView" class="hidden">
                <!-- NEW: Subscription Info & Management -->
                <div id="subscriptionInfo" class="hidden">
                    <span style="color: var(--text-secondary);">Plan:</span>
                    <span id="userPlanDisplay" class="plan-badge"></span>
                    <button id="managePlanBtn" class="btn btn-secondary btn-small">Manage</button>
                </div>
                <span class="user-email" id="userEmailDisplay"></span> 
                <button class="btn btn-secondary" onclick="signOut()">Sign Out</button> 
            </div>
        </div>
    </header>

    <main>
        <!-- ================================================================= -->
        <!-- ================= NEW REVAMPED PRICING SECTION ================== -->
        <!-- ================================================================= -->
        <section id="pricingSection" class="container">
            <div style="text-align: center; margin-bottom: 4rem;">
                <h1 class="main-title">Get Insider Trading Alerts, Instantly.</h1>
                <p class="subtitle">Stop guessing. Start receiving real-time notifications when CEOs, CFOs, Congressional leaders and other top executives make significant stock purchases and sales.</p>
            </div>
            
            <div class="pricing-container">
                <div class="plan-details">
                    <h3>Professional</h3>
                    <div class="plan-price">$4.99<span class="period">/month</span></div>
                    <button class="btn btn-primary plan-button" onclick="selectPlan('price_1RhYUtP1BWtn2d85uXwrZnvF', 'professional')" disabled>Choose Professional</button>
                </div>
                <div class="plan-features">
                    <h4>What's Included:</h4>
                    <ul>
                        <li><i class="fas fa-check-circle"></i> Email Notifications*</li>
                        <li><i class="fas fa-check-circle"></i> Live Dashboard of Insider Trades*</li>
                        <li><i class="fas fa-check-circle"></i> Live Dashboard of Congressional Trades*</li>
                        <li><i class="fas fa-check-circle"></i> Unlimited trade alerts</li>
                        <li><i class="fas fa-check-circle"></i> Full customization options</li>
                        <li><i class="fas fa-check-circle"></i> Priority support</li>
<li><i class="fas fa-check-circle"></i> Cancel Anytime</li>
                    </ul>
                    <p class="plan-disclaimer">*Live alerts based on filing date.</p>
                </div>
            </div>
        </section>
        <!-- ================================================================= -->
        <!-- =================== END REVAMPED PRICING SECTION ================== -->
        <!-- ================================================================= -->


        <!-- Dashboard Section -->
        <section id="dashboardSection" class="container hidden">
            <div class="dashboard-header">
                <div>
                    <h1 id="dashboard-title">Dashboard</h1>
                    <div class="dashboard-tabs">
                        <button class="tab-btn active" data-tab="insider-feed">Insider Purchases</button>
                        <button class="tab-btn" data-tab="senator-feed">Congressional Trades</button>
                        <button class="tab-btn" data-tab="settings">Notification Settings</button>
                        <button class="tab-btn hidden" id="upgrade-tab-btn" onclick="scrollToPricing()">Upgrade Plan</button>
                    </div>
                </div>
            </div>

            <div id="tab-content-insider-feed" class="tab-content active"></div>
            <div id="tab-content-senator-feed" class="tab-content"></div>
            
            <!-- ================================================================= -->
            <!-- ======================= NEW SETTINGS TAB ======================== -->
            <!-- ================================================================= -->
            <div id="tab-content-settings" class="tab-content">
                <div class="settings-header">
                    <h2>Notification Preferences</h2>
                    <p>Customize your alerts to track the market moves that matter most to you. All alerts are delivered instantly via email.</p>
                </div>
                <div class="settings-split-grid">
                    <!-- Left Column: Insider Trading Alerts -->
                    <div class="settings-card">
                        <h3><i class="fas fa-user-tie"></i> Insider Trading Alerts</h3>
                        
                        <div class="settings-group">
                            <div class="label-text">Email Notifications</div>
                             <div class="switch-group">
                                <span>Insider Trade Alerts</span> 
                                <label class="switch"><input type="checkbox" id="insiderEmailToggle"><span class="slider"></span></label>
                            </div>
                        </div>

                        <div class="settings-group">
                            <label for="stockPrice" class="label-text">Stock Price (at least) <span class="recommended-tag">Research Recommended: $3+</span></label>
                            <input type="range" id="stockPrice" min="0" max="100" value="3">
                            <div id="stockPriceValue" class="text-secondary" style="text-align:right; font-size: 0.9rem; margin-top: 0.5rem;">$3.00</div>
                        </div>
                        <div class="settings-group">
                            <label for="tradeValue" class="label-text">Trade Value (at least)</label>
                            <input type="range" id="tradeValue" min="0" max="1000000" step="10000" value="0">
                            <div id="tradeValueValue" class="text-secondary" style="text-align:right; font-size: 0.9rem; margin-top: 0.5rem;">Any</div>
                        </div>
                         <div class="settings-group">
                            <label class="label-text">Insider Title <span class="recommended-tag">Research Recommended: CEO/CFO</span></label>
                            <div class="multi-select-group">
                                <label><input type="checkbox" name="insiderTitle" value="CEO" hidden><span>CEO</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="CFO" hidden><span>CFO</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="Director" hidden><span>Director</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="Officer" hidden><span>Officer</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="President" hidden><span>President</span></label>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Senator Trading Alerts -->
                    <div class="settings-card">
                        <h3><i class="fas fa-landmark"></i> Senator Trading Alerts</h3>
                        <div class="settings-group">
                             <div class="label-text">Email Notifications</div>
                             <div class="switch-group">
                                <span>Senator Trade Alerts</span> 
                                <label class="switch"><input type="checkbox" id="senatorEmailToggle"><span class="slider"></span></label>
                            </div>
                        </div>
                        <div class="settings-group">
                            <label class="label-text">Top Companies Watchlist</label>
                            <div class="multi-select-group" id="company-watchlist">
                                <label><input type="checkbox" name="companyWatchlist" value="NVIDIA Corp" hidden><span>NVIDIA Corp</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Microsoft Corp" hidden><span>Microsoft Corp</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Apple Inc" hidden><span>Apple Inc</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Amazon.com Inc" hidden><span>Amazon.com Inc</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Alphabet Inc." hidden><span>Alphabet Inc.</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Meta Platforms, Inc." hidden><span>Meta Platforms</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Berkshire Hathaway Inc." hidden><span>Berkshire Hathaway</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Eli Lilly and Co" hidden><span>Eli Lilly & Co.</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Broadcom Inc." hidden><span>Broadcom Inc.</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Tesla, Inc." hidden><span>Tesla, Inc.</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Visa Inc." hidden><span>Visa Inc.</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="JPMorgan Chase & Co." hidden><span>JPMorgan Chase</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Walmart Inc." hidden><span>Walmart Inc.</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Exxon Mobil Corp" hidden><span>Exxon Mobil</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="UnitedHealth Group Inc." hidden><span>UnitedHealth Group</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Procter & Gamble Co" hidden><span>Procter & Gamble</span></label>
                                <label><input type="checkbox" name="companyWatchlist" value="Costco Wholesale Corp" hidden><span>Costco</span></label>
                            </div>
                        </div>
                        <div class="settings-group">
                            <label class="label-text">Top Senators Watchlist</label>
                            <div class="multi-select-group" id="senator-watchlist">
                                <label><input type="checkbox" name="senatorWatchlist" value="Ron Wyden" hidden>
                                    <span>
                                        <div class="senator-name-highlight">Ron Wyden</div>
                                        <div class="senator-subtext">1‑year return (2024): +123.8%</div>
                                    </span>
                                </label>
                                <label><input type="checkbox" name="senatorWatchlist" value="Rick Scott" hidden>
                                    <span>
                                        <div class="senator-name-highlight">Rick Scott</div>
                                        <div class="senator-subtext">invested approximately $4.5 M in 2024</div>
                                    </span>
                                </label>
                                <label><input type="checkbox" name="senatorWatchlist" value="Rand Paul" hidden><span>Rand Paul</span></label>
                                <label><input type="checkbox" name="senatorWatchlist" value="Mitch McConnell" hidden>
                                    <span>
                                        <div class="senator-name-highlight">Mitch McConnell</div>
                                        <div class="senator-subtext">$1.7M earned in single month June 2025</div>
                                    </span>
                                </label>
                                <label><input type="checkbox" name="senatorWatchlist" value="Susan Collins" hidden><span>Susan Collins</span></label>
                                <label><input type="checkbox" name="senatorWatchlist" value="Thomas Carper" hidden><span>Thomas Carper</span></label>
                                <label><input type="checkbox" name="senatorWatchlist" value="Sheldon Whitehouse" hidden><span>Sheldon Whitehouse</span></label>
                                <label><input type="checkbox" name="senatorWatchlist" value="John Hickenlooper" hidden><span>John Hickenlooper</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="save-settings-container">
                    <button class="btn btn-primary" onclick="saveSettings()">Save All Settings</button>
                </div>
            </div>
             <!-- ================================================================= -->
             <!-- ===================== END NEW SETTINGS TAB ====================== -->
             <!-- ================================================================= -->
        </section>
    </main>

    <footer class="disclaimer">
        <p>Disclaimer: DarkHorse is not a registered investment advisor. The information provided is for informational purposes only and does not constitute financial, investment, or other professional advice. All trading involves risk. Past performance is not indicative of future results. For all questions or subscription help please email support@aethnora.com</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQY_Q9NBc3hmd44QhovkytcXRyzvV4Ips",
            authDomain: "darkhorsetrades-bd89e.firebaseapp.com",
            projectId: "darkhorsetrades-bd89e",
            storageBucket: "darkhorsetrades-bd89e.appspot.com",
            messagingSenderId: "528610189023",
            appId: "1:528610189023:web:1f8741bfb0f8635bf9d36a"
        };
        // IMPORTANT: Use the correct LIVE publishable key from your Stripe Dashboard
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51RXnm1P1BWtn2d85f5PQ79tdyvhapp0rYDo0yDoH7SVWyWpyLdW4F5oX2RmKQ6KGZEJOXCRoU5WWEVOtJMJ8Y86P001uNGik7B';
        const SERVER_URL = 'https://darkhorse-backend.onrender.com';
        const INSIDER_DATA_URL = 'https://insider-trading-api.onrender.com/api/insiders';
        const SENATOR_DATA_URL = 'https://senator-filings.onrender.com/data';
        
       const PROXIED_SENATOR_DATA_URL = SENATOR_DATA_URL;



        // --- INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        // --- DOM Elements ---
        const authOverlay = document.getElementById('authOverlay'), authModal = document.getElementById('authModal'), authForm = document.getElementById('authForm'), authError = document.getElementById('authError'), authSubmit = document.getElementById('authSubmit'), authToggleLink = document.getElementById('authToggleLink'), authTitle = document.getElementById('authTitle'), authToggleText = document.getElementById('authToggleText');
        const processingOverlay = document.getElementById('processingOverlay'), processingProgress = document.getElementById('processingProgress');
        const loggedOutView = document.getElementById('loggedOutView'), loggedInView = document.getElementById('loggedInView'), userEmailDisplay = document.getElementById('userEmailDisplay');
        const pricingSection = document.getElementById('pricingSection'), dashboardSection = document.getElementById('dashboardSection');
        const insiderFeedTabContent = document.getElementById('tab-content-insider-feed'), senatorFeedTabContent = document.getElementById('tab-content-senator-feed'), upgradeTabBtn = document.getElementById('upgrade-tab-btn'), dashboardTitle = document.getElementById('dashboard-title');
        const tabs = document.querySelectorAll('.tab-btn'), tabContents = document.querySelectorAll('.tab-content');
        const subscriptionInfo = document.getElementById('subscriptionInfo'), userPlanDisplay = document.getElementById('userPlanDisplay');


        // --- App State ---
        let appState = {
            currentUser: null,
            userProfile: null,
            isSignUp: false,
            unsubscribeUserProfile: null,
            activeTradeDetails: null,
            pollingInterval: null,
            debugMode: false,
            loadedWidgets: new Set()
        };

        // --- DEBUG FUNCTIONS ---
        window.toggleDebug = () => {
            appState.debugMode = !appState.debugMode;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('hidden', !appState.debugMode);
            if (appState.debugMode) refreshDebugInfo();
        };

        window.refreshDebugInfo = async () => {
            const debugInfo = document.getElementById('debugInfo');
            const info = {
                'User': appState.currentUser ? `${appState.currentUser.uid} (${appState.currentUser.email})` : 'Not logged in',
                'Profile': appState.userProfile ? `Plan: ${appState.userProfile.subscription?.planId || 'none'}, Status: ${appState.userProfile.subscription?.status || 'none'}` : 'No profile',
                'Server Health': 'Checking...',
                'Insider API': 'Checking...',
                'Senator API': 'Checking...'
            };

            debugInfo.innerHTML = Object.entries(info).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');

            try {
                const response = await fetch(`${SERVER_URL}/health`);
                info['Server Health'] = response.ok ? '✅ OK' : '❌ Error';
            } catch (error) {
                info['Server Health'] = '❌ Unreachable';
            }

            try {
                const response = await fetchWithCORS(INSIDER_DATA_URL);
                info['Insider API'] = response.ok ? '✅ OK' : '❌ Error';
            } catch (error) {
                info['Insider API'] = '❌ CORS/Unreachable';
            }
            
            try {
                const response = await fetchWithCORS(PROXIED_SENATOR_DATA_URL); 
                info['Senator API'] = response.ok ? '✅ OK' : '❌ Error';
            } catch (error) {
                info['Senator API'] = '❌ CORS/Unreachable';
            }

            debugInfo.innerHTML = Object.entries(info).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');
        };

        // --- ENHANCED LOGGING ---
        const log = (level, message, data = null) => {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`, data || '');
            if (appState.debugMode) {
                refreshDebugInfo();
            }
        };

        // --- CORS-AWARE FETCH FUNCTION ---
        async function fetchWithCORS(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
            } catch (error) {
                log('error', 'Fetch failed', { url, error: error.message });
                throw error;
            }
        }

        // --- AUTHENTICATION & PAGE LOAD ---
        auth.onAuthStateChanged(user => {
            appState.currentUser = user;
            const planButtons = document.querySelectorAll('.plan-button');
            if (user) {
                log('info', 'User authenticated', { uid: user.uid, email: user.email });
                handleUserLogin();
                planButtons.forEach(button => button.disabled = false);
            } else {
                log('info', 'User logged out');
                handleUserLogout();
                planButtons.forEach(button => button.disabled = true);
            }
            handlePostPaymentRedirect();
        });

        function handlePostPaymentRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                log('info', 'Post-payment redirect detected, starting subscription polling');
                processingOverlay.classList.remove('hidden');
                processingOverlay.classList.add('show');
                window.history.replaceState(null, '', window.location.pathname);
                
                let attempts = 0;
                const maxAttempts = 30; 
                if (appState.pollingInterval) clearInterval(appState.pollingInterval);
                
                appState.pollingInterval = setInterval(async () => {
                    attempts++;
                    const remainingAttempts = maxAttempts - attempts;
                    processingProgress.textContent = `Checking subscription status... (${remainingAttempts} attempts remaining)`;
                    
                    if (appState.currentUser) {
                        try {
                            const userDoc = await db.collection('users').doc(appState.currentUser.uid).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                // *** FIX: Check the correct nested status field ***
                                if (userData.subscription && userData.subscription.status === 'active') {
                                    log('success', 'Subscription activated successfully');
                                    clearInterval(appState.pollingInterval);
                                    appState.pollingInterval = null;
                                    appState.userProfile = { uid: userDoc.id, ...userData };
                                    processingOverlay.classList.remove('show');
                                    processingOverlay.classList.add('hidden');
                                    updateDashboardView();
                                    return;
                                }
                            }
                        } catch (error) {
                            log('error', 'Error checking subscription status', error);
                        }
                    }
                    if (attempts >= maxAttempts) {
                        log('error', 'Subscription polling timeout');
                        clearInterval(appState.pollingInterval);
                        appState.pollingInterval = null;
                        processingOverlay.classList.remove('show');
                        processingOverlay.classList.add('hidden');
                        displayMessage('Subscription activation is taking longer than expected. Please refresh the page or contact support if the issue persists.', 'error');
                    }
                }, 2000);
            }
            if (urlParams.has('canceled')) {
                log('info', 'Payment canceled');
                displayMessage('Your payment was canceled. You can choose a plan at any time.', 'info');
                window.history.replaceState(null, '', window.location.pathname);
            }
        }

        function displayMessage(message, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.className = `status-message ${type}`;
            messageBox.textContent = message;
            messageBox.style.position = 'fixed';
            messageBox.style.top = '20px';
            messageBox.style.left = '50%';
            messageBox.style.transform = 'translateX(-50%)';
            messageBox.style.zIndex = '10000';
            messageBox.style.padding = '15px 25px';
            messageBox.style.borderRadius = '8px';
            messageBox.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
            messageBox.style.transition = 'opacity 0.5s ease-in-out';
            messageBox.style.opacity = '0';
            document.body.appendChild(messageBox);

            setTimeout(() => { messageBox.style.opacity = '1'; }, 10);
            setTimeout(() => {
                messageBox.style.opacity = '0';
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 5000);
        }

        function handleUserLogin() {
            loggedInView.classList.remove('hidden');
            loggedOutView.classList.add('hidden');
            userEmailDisplay.textContent = appState.currentUser.email;

            const userDocRef = db.collection('users').doc(appState.currentUser.uid);
            appState.unsubscribeUserProfile = userDocRef.onSnapshot(async (doc) => {
                if (doc.exists) {
                    appState.userProfile = { uid: doc.id, ...doc.data() };
                } else {
                    log('info', 'Creating initial user profile');
                    await createInitialUserProfile(userDocRef);
                }
                updateDashboardView();
            }, (error) => {
                log('error', 'Error listening to user profile', error);
            });
        }

        async function createInitialUserProfile(userDocRef) {
            const initialProfile = {
                email: appState.currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                subscription: { planId: null, status: 'none' },
                settings: {
                    insiderEmail: true,
                    senatorEmail: true,
                    filters: { 
                        stockPrice: 3, 
                        tradeValue: 0, 
                        titles: ['CEO', 'CFO'] 
                    },
                    senatorWatchlist: [],
                    companyWatchlist: []
                }
            };
            try {
                await userDocRef.set(initialProfile, { merge: true });
                appState.userProfile = initialProfile;
            } catch (error) {
                log('error', 'Error creating user profile', error);
            }
        }

        function handleUserLogout() {
            if (appState.unsubscribeUserProfile) appState.unsubscribeUserProfile();
            if (appState.pollingInterval) clearInterval(appState.pollingInterval);
            appState.userProfile = null;
            loggedInView.classList.add('hidden');
            loggedOutView.classList.remove('hidden');
            subscriptionInfo.classList.add('hidden'); // Hide plan info on logout
            dashboardSection.classList.add('hidden');
            pricingSection.classList.remove('hidden');
        }

        window.signOut = () => auth.signOut();
        
        window.showAuthModal = (signUp) => {
            appState.isSignUp = signUp;
            authOverlay.classList.add('show');
            authTitle.textContent = signUp ? 'Create an Account' : 'Sign In';
            authSubmit.textContent = signUp ? 'Sign Up' : 'Sign In';
            authToggleText.textContent = signUp ? "Already have an account?" : "Don't have an account?";
            authToggleLink.textContent = signUp ? 'Sign In' : 'Sign Up';
            authError.classList.add('hidden');
        };
        
        window.closeAuthModal = () => authOverlay.classList.remove('show');
        authOverlay.addEventListener('click', (e) => { if (e.target === authOverlay) closeAuthModal(); });
        authToggleLink.addEventListener('click', (e) => { e.preventDefault(); showAuthModal(!appState.isSignUp); });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authSubmit.disabled = true;
            authSubmit.textContent = 'Processing...';
            authError.classList.add('hidden');

            try {
                if (appState.isSignUp) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
                closeAuthModal();
            } catch (error) {
                authError.textContent = error.message;
                authError.classList.remove('hidden');
            } finally {
                authSubmit.disabled = false;
                authSubmit.textContent = appState.isSignUp ? 'Sign Up' : 'Sign In';
            }
        });

        // --- NEW: Google Sign-In Logic ---
        const googleSignInBtn = document.getElementById('googleSignInBtn');

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            authSubmit.disabled = true;
            googleSignInBtn.disabled = true;
            authError.classList.add('hidden');

            try {
                // This will either sign in a new user, or sign in an existing Google user.
                // The onAuthStateChanged listener will handle the UI update.
                await auth.signInWithPopup(provider);
                closeAuthModal();
            } catch (error) {
                // This block is crucial for linking accounts.
                if (error.code === 'auth/account-exists-with-different-credential') {
                    const email = error.email;
                    const pendingCred = error.credential;
                    
                    // A custom, styled modal would be better for UX than a native prompt.
                    const password = prompt(
                        `An account already exists for ${email}. ` +
                        `Please enter the password for that account to link it with your Google Sign-In.`
                    );
                    
                    if (password) {
                        try {
                            // Step 1: Sign in the user with their original email and password.
                            const userCredential = await auth.signInWithEmailAndPassword(email, password);
                            
                            // Step 2: Link the pending Google credential to the now-signed-in user.
                            await userCredential.user.linkWithCredential(pendingCred);
                            
                            displayMessage('Successfully linked your Google account!', 'success');
                            closeAuthModal();
                        } catch (linkError) {
                            log('error', 'Failed to link Google account', linkError);
                            authError.textContent = 'Linking failed: ' + linkError.message;
                            authError.classList.remove('hidden');
                        }
                    } else {
                        // User cancelled the password prompt.
                        authError.textContent = 'Account linking cancelled.';
                        authError.classList.remove('hidden');
                    }
                } else {
                    // Handle other types of sign-in errors.
                    log('error', 'Google Sign-In failed', error);
                    authError.textContent = 'Google Sign-In failed: ' + error.message;
                    authError.classList.remove('hidden');
                }
            } finally {
                // Re-enable buttons regardless of outcome.
                authSubmit.disabled = false;
                googleSignInBtn.disabled = false;
            }
        }

        googleSignInBtn.addEventListener('click', signInWithGoogle);
        // --- END NEW SECTION ---


        // --- OPTIMIZED: selectPlan function ---
        window.selectPlan = async (priceId, planName) => {
            // Guard clauses: Ensure we have a user and their profile before proceeding.
            if (!appState.currentUser) { 
                showAuthModal(false); 
                return; 
            }
            if (!appState.userProfile) {
                displayMessage('User profile is still loading. Please try again in a moment.', 'info');
                return;
            }
            
            const checkoutButton = event.target;
            const originalText = checkoutButton.textContent;
            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Redirecting...';

            try {
                // Prepare the payload with data we already have on the frontend.
                // This avoids the need for the backend to re-fetch from Firestore.
                const payload = {
                    priceId: priceId,
                    planName: planName,
                    userId: appState.currentUser.uid,
                    email: appState.userProfile.email, // Pass the email
                    stripeCustomerId: appState.userProfile.stripeCustomerId || null // Pass existing ID or null
                };

                log('info', 'Creating checkout session with optimized payload', payload);

                const response = await fetch(`${SERVER_URL}/create-checkout-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Server error: ${errorData.error || 'Unknown error'}`);
                }

                const { sessionId } = await response.json();
                if (!sessionId) throw new Error('No session ID received from server');
                
                const { error } = await stripe.redirectToCheckout({ sessionId });
                if (error) throw error;

            } catch (error) {
                log('error', 'Checkout session creation failed', error);
                displayMessage(`Could not initiate payment: ${error.message}`, 'error');
                checkoutButton.disabled = false;
                checkoutButton.textContent = originalText;
            }
        };
        // --- END OPTIMIZED FUNCTION ---


        // NEW: Function to redirect to Stripe Customer Portal
        window.redirectToCustomerPortal = async () => {
            log('info', 'Redirecting to customer portal');
            const manageButton = document.getElementById('managePlanBtn');
            manageButton.disabled = true;
            manageButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const response = await fetch(`${SERVER_URL}/create-portal-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: appState.currentUser.uid })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create portal session.');
                }

                const { url } = await response.json();
                window.location.href = url;
            } catch (error) {
                log('error', 'Could not open customer portal', error);
                displayMessage(`Could not open the management page: ${error.message}`, 'error');
                manageButton.disabled = false;
                manageButton.textContent = 'Manage';
            }
        };


        // --- VIEW MANAGEMENT & RENDERING ---
        function updateDashboardView() {
            if (!appState.userProfile) return;

            const { subscription } = appState.userProfile;
            // *** FIX: Check the correct nested status field ***
            if (subscription && subscription.status === 'active') {
                processingOverlay.classList.remove('show');
                processingOverlay.classList.add('hidden');
                pricingSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');

                const { planId } = subscription;
                
                subscriptionInfo.classList.remove('hidden');
                userPlanDisplay.textContent = planId || 'none';
                userPlanDisplay.className = `plan-badge ${planId || 'none'}`;

                upgradeTabBtn.classList.toggle('hidden', planId !== 'basic');
                
                if (planId === 'basic') {
                    dashboardTitle.textContent = "Dashboard Preview";
                    renderLockedDashboard();
                } else {
                    dashboardTitle.textContent = "Dashboard";
                    renderFullDashboard();
                }
                populateSettingsView();
            } else {
                subscriptionInfo.classList.add('hidden');
                if (!processingOverlay.classList.contains('show')) {
                    dashboardSection.classList.add('hidden');
                    pricingSection.classList.remove('hidden');
                }
            }
        }

        function renderLockedDashboard() {
            const lockedHTML = `
                <div class="locked-dashboard">
                    <div class="locked-content">
                        <div class="feed-container">
                        <table class="trades-table">
                            <thead><tr><th>Filing Date</th><th>Trade Date</th><th>Company</th><th>Insider</th><th>Title</th><th>Price</th><th>Quantity</th><th>ΔOwn</th><th>Value</th></tr></thead>
                            <tbody>
                                <tr><td>...</td><td>...</td><td>Cyberdyne Systems<br><small>CDYNE</small></td><td>Miles Dyson</td><td class="insider-title">CTO</td><td>$45.25</td><td>99,500</td><td>+15.2%</td><td>$4,502,500</td></tr>
                                <tr><td>...</td><td>...</td><td>Stark Industries<br><small>STRK</small></td><td>Pepper Potts</td><td class="insider-title">CEO</td><td>$8.59</td><td>99,400</td><td>+8.3%</td><td>$853,900</td></tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="lock-overlay">
                        <i class="fas fa-lock"></i><h2>Full Feed Locked</h2>
                        <p>Upgrade to an Advanced or Professional plan to unlock the live feed, real-time alerts, and advanced charts.</p>
                        <button class="btn btn-primary" onclick="scrollToPricing()">Upgrade Your Plan</button>
                    </div>
                </div>`;
            insiderFeedTabContent.innerHTML = lockedHTML;
            senatorFeedTabContent.innerHTML = lockedHTML;
        }
        
        async function renderFullDashboard() {
            insiderFeedTabContent.innerHTML = `
                <div class="feed-container">
                    <table class="trades-table">
                        <thead><tr><th>Filing Date</th><th>Trade Date</th><th>Company</th><th>Insider</th><th>Title</th><th>Price</th><th>Quantity</th><th>ΔOwn</th><th>Value</th><th></th></tr></thead>
                        <tbody id="insider-trades-tbody"></tbody>
                    </table>
                </div>`;
            
            senatorFeedTabContent.innerHTML = `
                <div class="feed-container">
                    <table class="trades-table">
                         <thead><tr><th>Filing Date</th><th>Transaction Date</th><th>Senator</th><th>Company</th><th>Ticker</th><th>Transaction Type</th><th>Amount</th><th></th></tr></thead>
                        <tbody id="senator-trades-tbody"></tbody>
                    </table>
                </div>`;

            await populateTradesTable();
            await populateSenatorTradesTable();
        }

        function formatDateCell(dateString, showTime) {
            if (!dateString || typeof dateString !== 'string') {
                return '<td class="date-cell"><div class="date-wrapper">N/A</div></td>';
            }

            const parts = dateString.split(' ');
            const datePart = parts[0];
            const timePart = parts.length > 1 ? parts[1] : null;

            const date = new Date(datePart);
            if (isNaN(date.getTime())) {
                return `<td class="date-cell"><div class="date-wrapper">${dateString}</div></td>`;
            }

            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const month = monthNames[date.getMonth()];
            const day = date.getDate();
            
            let timeHtml = '';
            if (showTime && timePart) {
                let [hours, minutes] = timePart.split(':');
                let period = 'AM';
                hours = parseInt(hours, 10);
                if (hours >= 12) {
                    period = 'PM';
                    if (hours > 12) hours -= 12;
                }
                if (hours === 0) hours = 12;
                timeHtml = `<div class="date-time">${hours}:${minutes} ${period}</div>`;
            }

            return `
                <td class="date-cell">
                    <div class="date-wrapper">
                        <div class="date-icon-display">
                            <span class="date-icon-month">${month}</span>
                            <span class="date-icon-day">${day}</span>
                        </div>
                        ${timeHtml}
                    </div>
                </td>
            `;
        }

        async function populateTradesTable() {
            const tbody = document.getElementById('insider-trades-tbody');
            if (!tbody) return;
            
            log('debug', 'Populating insider trades table');
            tbody.innerHTML = '';
            for(let i=0; i<5; i++) { tbody.innerHTML += `<tr class="skeleton-row"><td colspan="10"><div class="skeleton-loader" style="width: 100%; height: 24px;"></div></td></tr>`; }

            try {
                log('debug', 'Attempting to fetch insider data from API', { url: INSIDER_DATA_URL });
                const response = await fetchWithCORS(INSIDER_DATA_URL);
                const trades = await response.json();
                
                log('success', 'Raw insider trades data received', { count: trades.length, sample: trades[0] });
                
                const cleanedTrades = trades.map(trade => {
                    const cleaned = {};
                    for (const [key, value] of Object.entries(trade)) {
                        let cleanKey = key.replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
                        if (cleanKey.toLowerCase().includes('filing') && cleanKey.toLowerCase().includes('date')) cleaned['Filing Date'] = value;
                        else if (cleanKey.toLowerCase().includes('trade') && cleanKey.toLowerCase().includes('date')) cleaned['Trade Date'] = value;
                        else if (cleanKey.toLowerCase().includes('company') && cleanKey.toLowerCase().includes('name')) cleaned['Company Name'] = value;
                        else if (cleanKey.toLowerCase() === 'ticker') cleaned['Ticker'] = value;
                        else if (cleanKey.toLowerCase().includes('insider') && cleanKey.toLowerCase().includes('name')) cleaned['Insider Name'] = value;
                        else if (cleanKey.toLowerCase() === 'title') cleaned['Title'] = value;
                        else if (cleanKey.toLowerCase().includes('trade') && cleanKey.toLowerCase().includes('type')) cleaned['Trade Type'] = value;
                        else if (cleanKey.toLowerCase() === 'price') cleaned['Price'] = value;
                        else if (cleanKey.toLowerCase() === 'qty') cleaned['Qty'] = value;
                        else if (cleanKey.toLowerCase() === 'owned') cleaned['Owned'] = value;
                        else if (cleanKey.includes('Own') || cleanKey.includes('Δ') || cleanKey.includes('Delta')) cleaned['ΔOwn'] = value;
                        else if (cleanKey.toLowerCase() === 'value') cleaned['Value'] = value;
                        else cleaned[cleanKey] = value;
                    }
                    return cleaned;
                });

                const purchasesTrades = cleanedTrades.filter(trade => {
                    const tradeType = (trade['Trade Type'] || '').toString().toLowerCase().trim();
                    return tradeType.includes('purchase') || tradeType.startsWith('p') || tradeType === 'p - purchase';
                });
                
                log('success', 'Insider trades data processed', { total: trades.length, purchases: purchasesTrades.length, sampleCleaned: purchasesTrades[0] });
                
                tbody.innerHTML = '';
                if (purchasesTrades.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding: 2rem;">No insider purchases found.</td></tr>`;
                    return;
                }

                purchasesTrades.slice(0, 100).forEach(trade => {
                    const tradeId = `insider-${trade.Ticker || 'UNKNOWN'}-${trade['Trade Date'] || Date.now()}`.replace(/[^a-zA-Z0-9-]/g, '');
                    const row = document.createElement('tr');
                    row.className = 'trade-row';
                    row.dataset.ticker = trade.Ticker || 'UNKNOWN';
                    row.dataset.id = tradeId;
                    
                    const filingDateStr = trade['Filing Date'] || '';
                    const tradeDateStr = trade['Trade Date'] || '';
                    const companyName = trade['Company Name'] || 'Unknown Company';
                    const ticker = trade.Ticker || 'N/A';
                    const insiderName = trade['Insider Name'] || 'Unknown';
                    const title = trade.Title || 'N/A';
                    
                    const priceStr = (trade.Price || '0').toString().replace(/[$,]/g, '');
                    const price = parseFloat(priceStr) || 0;
                    
                    const qtyStr = (trade.Qty || '0').toString().replace(/[,]/g, '');
                    const qty = parseInt(qtyStr) || 0;
                    
                    const deltaOwn = trade['ΔOwn'] || trade['Î"Own'] || trade['Delta Own'] || 'N/A';
                    
                    const valueStr = (trade.Value || '0').toString().replace(/[$,]/g, '');
                    const value = parseInt(valueStr) || 0;
                    
                    const filingDateCell = formatDateCell(filingDateStr, true);
                    const tradeDateCell = formatDateCell(tradeDateStr, false);

                    row.innerHTML = `
                        ${filingDateCell}
                        ${tradeDateCell}
                        <td><div class="company-name">${companyName}</div><div class="ticker">${ticker}</div></td>
                        <td>${insiderName}</td>
                        <td class="insider-title">${title}</td>
                        <td>$${price.toFixed(2)}</td>
                        <td>${qty.toLocaleString()}</td>
                        <td>${deltaOwn}</td>
                        <td>$${value.toLocaleString()}</td>
                        <td><i class="fas fa-chevron-down trade-toggle-icon"></i></td>`;
                    
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'trade-details-row';
                    detailsRow.innerHTML = `<td colspan="10" class="trade-details-cell"><div class="trade-details-content" id="details-content-${tradeId}"></div></td>`;

                    tbody.appendChild(row);
                    tbody.appendChild(detailsRow);

                    row.addEventListener('click', () => toggleTradeDetails(row, detailsRow, ticker, companyName));
                });
            } catch (error) {
                log('error', 'Failed to fetch or process insider trades', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align:center; padding: 2rem; color: var(--error-red);">
                            <div>Could not load insider trades feed.</div>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Error: ${error.message}
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 1rem; padding: 0.5rem 1rem;" onclick="populateTradesTable()">Retry</button>
                        </td>
                    </tr>`;
            }
        }

        async function populateSenatorTradesTable() {
            const tbody = document.getElementById('senator-trades-tbody');
            if (!tbody) return;

            log('debug', 'Populating senator trades table');
            tbody.innerHTML = '';
            for(let i=0; i<5; i++) { tbody.innerHTML += `<tr class="skeleton-row"><td colspan="8"><div class="skeleton-loader" style="width: 100%; height: 24px;"></div></td></tr>`; }

            try {
                log('debug', 'Attempting to fetch senator data', { url: PROXIED_SENATOR_DATA_URL });
                const response = await fetchWithCORS(PROXIED_SENATOR_DATA_URL);
                const rawTrades = await response.json();

                log('success', 'Raw senator trades data received', { count: rawTrades.length, sample: rawTrades[0] });
                
                const cleanedAndFilteredTrades = rawTrades.map(trade => {
                    // Create a new object and trim all string values from the raw trade
                    const cleanedTrade = Object.entries(trade).reduce((acc, [key, value]) => {
                        acc[key] = typeof value === 'string' 
                            ? value.trim().replace(/[\n\r]+/g, ' ').replace(/\s+/g, ' ').trim() 
                            : value;
                        return acc;
                    }, {});

                    let ticker = cleanedTrade.ticker || '';
                    let assetName = cleanedTrade.asset_name || '';

                    // If ticker is '--' or empty, check if the asset_name might be the ticker.
                    if (ticker === '--' || !ticker) {
                        const tickerRegex = /^[A-Z]{1,5}$/;
                        if (tickerRegex.test(assetName)) {
                            ticker = assetName;
                            assetName = 'N/A'; 
                        }
                    }

                    // Final object structure for rendering
                    return {
                        filing_date: cleanedTrade.file_date,
                        transaction_date: cleanedTrade.tx_date,
                        senator: `${cleanedTrade.first_name || ''} ${cleanedTrade.last_name || ''}`.trim(),
                        asset_description: assetName,
                        ticker: ticker,
                        type: cleanedTrade.order_type,
                        amount: cleanedTrade.tx_amount,
                    };
                }).filter(trade => {
                    // Filter out any trade that does not have a valid ticker after our cleaning process
                    return trade.ticker && trade.ticker !== '--' && trade.ticker.length > 0;
                });

                log('success', 'Senator trades data processed and filtered', { count: cleanedAndFilteredTrades.length, sample: cleanedAndFilteredTrades[0] });
                
                tbody.innerHTML = '';
                if (!cleanedAndFilteredTrades || cleanedAndFilteredTrades.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 2rem;">No valid senator trades found.</td></tr>`;
                    return;
                }

                cleanedAndFilteredTrades.slice(0, 50).forEach(trade => {
                    const ticker = trade.ticker;
                    const companyName = trade.asset_description;
                    const tradeId = `senator-${ticker}-${trade.transaction_date || Date.now()}`.replace(/[^a-zA-Z0-9-]/g, '');
                    const row = document.createElement('tr');
                    row.className = 'trade-row';
                    row.dataset.ticker = ticker;
                    row.dataset.id = tradeId;

                    const filingDateCell = formatDateCell(trade.filing_date, false);
                    const transactionDateCell = formatDateCell(trade.transaction_date, false);

                    row.innerHTML = `
                        ${filingDateCell}
                        ${transactionDateCell}
                        <td>${trade.senator || 'N/A'}</td>
                        <td><div class="company-name">${companyName}</div></td>
                        <td><div class="ticker">${ticker}</div></td>
                        <td>${trade.type || 'N/A'}</td>
                        <td>${trade.amount || 'N/A'}</td>
                        <td><i class="fas fa-chevron-down trade-toggle-icon"></i></td>
                    `;
                    
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'trade-details-row';
                    detailsRow.innerHTML = `<td colspan="8" class="trade-details-cell"><div class="trade-details-content" id="details-content-${tradeId}"></div></td>`;

                    tbody.appendChild(row);
                    tbody.appendChild(detailsRow);

                    row.addEventListener('click', () => toggleTradeDetails(row, detailsRow, ticker, companyName));
                });
            } catch (error) {
                log('error', 'Failed to fetch or process senator trades', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align:center; padding: 2rem; color: var(--error-red);">
                            <div>Could not load senator trades feed.</div>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Error: ${error.message}
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 1rem; padding: 0.5rem 1rem;" onclick="populateSenatorTradesTable()">Retry</button>
                        </td>
                    </tr>`;
            }
        }
        
        // Make the functions globally available for the retry buttons
        window.populateTradesTable = populateTradesTable;
        window.populateSenatorTradesTable = populateSenatorTradesTable;
        
        function toggleTradeDetails(row, detailsRow, ticker, companyName) {
            const rowId = row.dataset.id;
            const isActive = row.classList.contains('active-row');
            const toggleIcon = row.querySelector('.trade-toggle-icon');

            if (appState.activeTradeDetails && appState.activeTradeDetails !== rowId) {
                const oldActiveRow = document.querySelector(`.trade-row[data-id="${appState.activeTradeDetails}"]`);
                if (oldActiveRow) {
                    const oldDetailsRow = oldActiveRow.nextElementSibling;
                    const oldToggleIcon = oldActiveRow.querySelector('.trade-toggle-icon');
                    oldActiveRow.classList.remove('active-row');
                    if (oldDetailsRow) oldDetailsRow.classList.remove('active');
                    if (oldToggleIcon) oldToggleIcon.classList.remove('rotated');
                }
            }

            row.classList.toggle('active-row', !isActive);
            detailsRow.classList.toggle('active', !isActive);
            if (toggleIcon) toggleIcon.classList.toggle('rotated', !isActive);

            if (!isActive) {
                appState.activeTradeDetails = rowId;
                // FIX: Add a guard against invalid tickers like '--'
                if (ticker && ticker !== 'N/A' && ticker.trim() !== '--') {
                    loadAdvancedTradingViewWidgets(ticker, companyName, `details-content-${rowId}`);
                } else {
                    const container = document.getElementById(`details-content-${rowId}`);
                    if(container) container.innerHTML = `<div style="text-align:center; padding: 2rem; color: var(--text-secondary);">No valid ticker available for this asset.</div>`;
                }
            } else {
                appState.activeTradeDetails = null;
            }
        }

        function loadAdvancedTradingViewWidgets(ticker, companyName, containerId) {
            const container = document.getElementById(containerId);
            if (!container || appState.loadedWidgets.has(containerId)) return;
            
            log('debug', 'Loading TradingView widgets', { ticker, companyName, containerId });
            
            appState.loadedWidgets.add(containerId);
            
            container.innerHTML = `
                <div class="chart-section">
                    <div class="chart-header">
                        <h3>
                            <i class="fas fa-chart-line"></i>
                            Price Chart
                            <span class="ticker-badge">${ticker}</span>
                        </h3>
                    </div>
                    <div class="tradingview-widget-container" id="chart-${containerId}">
                        <div class="widget-loading">
                            <i class="fas fa-spinner"></i>
                            <div>Loading chart...</div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-section">
                    <div class="profile-header">
                        <h3>
                            <i class="fas fa-building"></i>
                            Company Profile
                        </h3>
                    </div>
                    <div class="profile-content">
                        <div class="fundamentals-widget" id="fundamentals-${containerId}">
                            <div class="widget-loading">
                                <i class="fas fa-spinner"></i>
                                <div>Loading company profile...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            if (!window.TradingView) {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/tv.js';
                script.async = true;
                script.onload = () => initializeWidgets(ticker, containerId);
                document.head.appendChild(script);
            } else {
                initializeWidgets(ticker, containerId);
            }
        }

        function initializeWidgets(ticker, containerId) {
            setTimeout(() => {
                try {
                    // Initialize Chart Widget
                    new TradingView.widget({
                        "autosize": true,
                        "symbol": ticker,
                        "interval": "D",
                        "timezone": "Etc/UTC",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "toolbar_bg": "#0a0f1c",
                        "enable_publishing": false,
                        "backgroundColor": "#0a0f1c",
                        "gridColor": "rgba(0, 198, 255, 0.2)",
                        "hide_side_toolbar": false,
                        "allow_symbol_change": true,
                        "details": true,
                        "hotlist": true,
                        "calendar": true,
                        "studies": ["Volume@tv-basicstudies", "MACD@tv-basicstudies"],
                        "container_id": `chart-${containerId}`,
                        "withdateranges": true,
                        "hide_top_toolbar": false,
                        "save_image": false
                    });

                    // FIX: Re-initialize the profile widget more robustly.
                    const profileContainer = document.getElementById(`fundamentals-${containerId}`);
                    if (profileContainer) {
                        // Clear any previous widget content to ensure a fresh instance
                        profileContainer.innerHTML = ''; 
                        
                        const widgetContainer = document.createElement('div');
                        widgetContainer.className = 'tradingview-widget-container';
                        widgetContainer.style.height = '100%';
                        widgetContainer.style.width = '100%';
                        widgetContainer.innerHTML = '<div class="tradingview-widget-container__widget" style="height:100%;width:100%;"></div>';
                        profileContainer.appendChild(widgetContainer);

                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-profile.js';
                        script.async = true;
                        
                        // Use JSON.stringify for safety and set height to 100%
                        const widgetConfig = {
                            "symbol": ticker,
                            "colorTheme": "dark",
                            "isTransparent": true,
                            "locale": "en",
                            "width": "100%",
                            "height": "100%" 
                        };
                        script.innerHTML = JSON.stringify(widgetConfig);
                        widgetContainer.appendChild(script);
                    }

                    log('success', 'TradingView widgets loaded successfully', { ticker, containerId });
                } catch (error) {
                    log('error', 'Failed to load TradingView widgets', { ticker, containerId, error });
                    const chartContainer = document.getElementById(`chart-${containerId}`);
                    const fundamentalsContainer = document.getElementById(`fundamentals-${containerId}`);
                    if (chartContainer) chartContainer.innerHTML = `<div class="widget-loading"><i class="fas fa-exclamation-triangle" style="color: var(--error-red);"></i><div>Failed to load chart for ` + ticker + `</div></div>`;
                    if (fundamentalsContainer) fundamentalsContainer.innerHTML = `<div class="widget-loading"><i class="fas fa-exclamation-triangle" style="color: var(--error-red);"></i><div>Failed to load company data</div></div>`;
                }
            }, 500);
        }

        // --- SETTINGS MANAGEMENT ---
        function populateSettingsView() {
            if (!appState.userProfile || !appState.userProfile.settings) return;
            
            const { planId } = appState.userProfile.subscription;
            const settings = appState.userProfile.settings || {}; // Ensure settings object exists
            const filters = settings.filters || {};
            const titles = filters.titles || [];
            const senatorWatchlist = settings.senatorWatchlist || [];
            const companyWatchlist = settings.companyWatchlist || [];
            
            const isCustomizable = (planId === 'advanced' || planId === 'professional');
            
            document.querySelectorAll('#tab-content-settings input, #tab-content-settings button').forEach(el => el.disabled = !isCustomizable);
            document.querySelectorAll('.settings-card').forEach(el => el.style.opacity = isCustomizable ? '1' : '0.5');

            // Insider Settings
            document.getElementById('insiderEmailToggle').checked = settings.insiderEmail !== false;
            const stockPrice = filters.stockPrice || 3;
            document.getElementById('stockPrice').value = stockPrice;
            updateSliderValue('stockPriceValue', stockPrice, val => `$${parseFloat(val).toFixed(2)}` );
            
            const tradeValue = filters.tradeValue || 0;
            document.getElementById('tradeValue').value = tradeValue;
            updateSliderValue('tradeValueValue', tradeValue, val => val > 0 ? `$${(val/1000).toLocaleString()}k` : 'Any');
            
            document.querySelectorAll('input[name="insiderTitle"]').forEach(el => {
                el.checked = titles.includes(el.value);
                const span = el.nextElementSibling;
                if (span) {
                    span.parentElement.style.background = el.checked ? 'var(--gradient-primary)' : 'rgba(0,0,0,0.25)';
                }
            });

            // Senator Settings
            document.getElementById('senatorEmailToggle').checked = settings.senatorEmail !== false;
            document.querySelectorAll('input[name="senatorWatchlist"]').forEach(el => {
                el.checked = senatorWatchlist.includes(el.value);
                const span = el.nextElementSibling;
                if (span) {
                    span.parentElement.style.background = el.checked ? 'var(--gradient-primary)' : 'rgba(0,0,0,0.25)';
                }
            });

            document.querySelectorAll('input[name="companyWatchlist"]').forEach(el => {
                el.checked = companyWatchlist.includes(el.value);
                const span = el.nextElementSibling;
                if (span) {
                    span.parentElement.style.background = el.checked ? 'var(--gradient-primary)' : 'rgba(0,0,0,0.25)';
                }
            });
        }

        window.saveSettings = async () => {
            const saveButton = event.target;
            const originalText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            const settingsToSave = {
                insiderEmail: document.getElementById('insiderEmailToggle').checked,
                senatorEmail: document.getElementById('senatorEmailToggle').checked,
                filters: {
                    stockPrice: parseFloat(document.getElementById('stockPrice').value),
                    tradeValue: parseInt(document.getElementById('tradeValue').value),
                    titles: Array.from(document.querySelectorAll('input[name="insiderTitle"]:checked')).map(el => el.value)
                },
                senatorWatchlist: Array.from(document.querySelectorAll('input[name="senatorWatchlist"]:checked')).map(el => el.value),
                companyWatchlist: Array.from(document.querySelectorAll('input[name="companyWatchlist"]:checked')).map(el => el.value)
            };
            
            try {
                await db.collection('users').doc(appState.currentUser.uid).set({ settings: settingsToSave }, { merge: true });
                displayMessage('Settings saved successfully!', 'success');
            } catch (error) {
                log('error', 'Failed to save settings', error);
                displayMessage("Failed to save settings. Please try again.", 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        };
        
        // --- EVENT LISTENERS ---
        tabs.forEach(tab => tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            tabContents.forEach(c => c.classList.toggle('active', c.id === `tab-content-${tab.dataset.tab}`));
        }));
        
        // Delegated event listener for all multi-select checkboxes
        document.getElementById('tab-content-settings').addEventListener('change', e => {
            if (e.target.matches('.multi-select-group input[type="checkbox"]')) {
                const span = e.target.nextElementSibling;
                if (span) {
                     span.parentElement.style.background = e.target.checked ? 'var(--gradient-primary)' : 'rgba(0,0,0,0.25)';
                }
            }
        });

        document.getElementById('managePlanBtn').addEventListener('click', redirectToCustomerPortal);
        
        function updateSliderValue(elementId, value, formatter) { 
            const el = document.getElementById(elementId);
            if(el) el.textContent = formatter(value); 
        }
        
        document.getElementById('stockPrice').addEventListener('input', e => updateSliderValue('stockPriceValue', e.target.value, val => `$${parseFloat(val).toFixed(2)}`));
        document.getElementById('tradeValue').addEventListener('input', e => updateSliderValue('tradeValueValue', e.target.value, val => val > 0 ? `$${(val/1000).toLocaleString()}k` : 'Any'));
        window.scrollToPricing = () => pricingSection.scrollIntoView({ behavior: 'smooth' });

        if (appState.debugMode) refreshDebugInfo();
    });
    </script>
</body>
</html>
