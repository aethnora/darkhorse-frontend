<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DarkHorse Alerts - Insider Trade Notifications</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- TradingView Charting Library -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <style>
        :root {
            --primary-blue: #0a74da;
            --accent-cyan: #00c6ff;
            --dark-bg: #0a0f1c;
            --card-bg: #10182c;
            --card-bg-glass: rgba(16, 24, 44, 0.7);
            --border-color: rgba(0, 198, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #a0a8b8;
            --text-tertiary: #6b7f99;
            --gradient-primary: linear-gradient(135deg, #0a74da 0%, #00c6ff 100%);
            --success-green: #00ff88;
            --warning-yellow: #ffd700;
            --error-red: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- UTILITY & LAYOUT --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .hidden { display: none !important; }
        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5; background: var(--dark-bg); overflow: hidden; }
        .bg-animation::before { content: ''; position: absolute; width: 200%; height: 200%; top: -50%; left: -50%; background: radial-gradient(circle at 20% 50%, rgba(0, 198, 255, 0.15) 0%, transparent 40%), radial-gradient(circle at 80% 80%, rgba(10, 116, 218, 0.15) 0%, transparent 40%); animation: floatAnimation 30s ease-in-out infinite; }
        @keyframes floatAnimation { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(40px, -30px) rotate(5deg); } }

        /* --- BUTTONS & INPUTS --- */
        .btn { display: inline-block; padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: 600; font-size: 1rem; text-align: center; cursor: pointer; transition: all 0.3s ease; border: none; text-decoration: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .btn-primary { background: var(--gradient-primary); color: var(--text-primary); box-shadow: 0 5px 20px rgba(10, 116, 218, 0.3); }
        .btn-primary:not(:disabled):hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 198, 255, 0.4); }
        .btn-secondary { background: var(--card-bg); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:not(:disabled):hover { background-color: rgba(0, 198, 255, 0.1); border-color: var(--accent-cyan); }
        .input-field { width: 100%; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem 1rem; color: var(--text-primary); font-size: 1rem; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 0 2px rgba(0, 198, 255, 0.2); }

        /* --- HEADER & AUTH --- */
        .page-header { padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: rgba(10, 15, 28, 0.8); backdrop-filter: blur(10px); z-index: 100; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 1.5rem; font-weight: 900; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .user-controls .user-email { color: var(--text-secondary); margin-right: 1rem; }
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .auth-overlay.show { opacity: 1; pointer-events: auto; }
        .auth-modal { background: var(--card-bg-glass); border-radius: 16px; padding: 2.5rem; width: 90%; max-width: 400px; border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); transform: scale(0.95); transition: transform 0.3s ease; }
        .auth-overlay.show .auth-modal { transform: scale(1); }
        .auth-modal h2 { text-align: center; margin-bottom: 2rem; font-size: 2rem; font-weight: 700; }
        .auth-form .form-group { margin-bottom: 1.5rem; }
        .status-message { border-radius: 8px; padding: 0.75rem; font-size: 0.9rem; text-align: center; margin-bottom: 1.5rem; }
        .status-message.error { background: rgba(255, 107, 107, 0.2); border: 1px solid var(--error-red); color: var(--error-red); }
        .status-message.success { background: rgba(0, 255, 136, 0.1); border: 1px solid var(--success-green); color: var(--success-green); }
        .auth-toggle { text-align: center; margin-top: 1.5rem; color: var(--text-secondary); }
        .auth-toggle a { color: var(--accent-cyan); text-decoration: none; font-weight: 600; }

        /* --- PRICING SECTION --- */
        .pricing-section h1 { text-align: center; font-size: 3rem; font-weight: 900; margin-bottom: 1rem; }
        .pricing-section .subtitle { text-align: center; font-size: 1.2rem; color: var(--text-secondary); max-width: 600px; margin: 0 auto 4rem; }
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; align-items: center; }
        .pricing-card { background: var(--card-bg-glass); border: 1px solid var(--border-color); border-radius: 16px; padding: 2.5rem 2rem; transition: all 0.3s ease; display: flex; flex-direction: column; height: 100%; }
        .pricing-card h3 { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--text-primary); }
        .pricing-card .plan-desc { color: var(--text-secondary); margin-bottom: 2rem; min-height: 40px; }
        .price { font-size: 3.5rem; font-weight: 900; margin-bottom: 0.5rem; }
        .price .period { font-size: 1rem; font-weight: 500; color: var(--text-secondary); }
        .features-list { list-style: none; margin: 2rem 0; flex-grow: 1; }
        .features-list li { margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; color: var(--text-secondary); }
        .features-list li i.fa-check-circle { color: var(--success-green); }
        .features-list li i.fa-lock { color: var(--warning-yellow); }
        .pricing-card.recommended { transform: scale(1.05); border: 2px solid var(--accent-cyan); box-shadow: 0 0 40px rgba(0, 198, 255, 0.2); position: relative; }
        .recommended-badge { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: var(--gradient-primary); color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; letter-spacing: 1px; }

        /* --- DASHBOARD LAYOUT --- */
        .dashboard-header { margin-bottom: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem; }
        .dashboard-header h1 { font-size: 2.5rem; }
        .dashboard-tabs { display: flex; gap: 1rem; margin-top: 1rem; }
        .tab-btn { background: none; border: none; color: var(--text-secondary); font-size: 1rem; font-weight: 600; padding: 0.5rem 0; cursor: pointer; position: relative; transition: color 0.3s ease; }
        .tab-btn::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--accent-cyan); transform: scaleX(0); transition: transform 0.3s ease; }
        .tab-btn.active { color: var(--text-primary); }
        .tab-btn.active::after { transform: scaleX(1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- SETTINGS REDESIGN --- */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
        .settings-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 2rem; }
        .settings-card h3 { font-size: 1.25rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .settings-card h3 i { color: var(--accent-cyan); }
        .settings-group { margin-bottom: 1.5rem; }
        .settings-group:last-child { margin-bottom: 0; }
        .settings-group label { display: block; margin-bottom: 0.75rem; font-weight: 500; color: var(--text-secondary); }
        .switch-group { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 0.75rem 1rem; border-radius: 8px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--text-tertiary); transition: .4s; border-radius: 28px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-green); }
        input:checked + .slider:before { transform: translateX(22px); }
        .multi-select-group { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .multi-select-group label { background: rgba(0,0,0,0.2); padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; }
        .multi-select-group input:checked + span { background: var(--gradient-primary); color: white; }
        .recommended-tag { font-size: 0.7rem; color: var(--warning-yellow); margin-left: 0.5rem; }
        .save-settings-container { margin-top: 2rem; text-align: right; }

        /* --- ENHANCED TRADES FEED & DROPDOWN --- */
        .trades-table { width: 100%; border-collapse: collapse; table-layout: auto; }
        .trades-table th { text-align: left; padding: 1rem; color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .trades-table td { padding: 1rem; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .trades-table tbody tr.trade-row { cursor: pointer; transition: all 0.3s ease; position: relative; }
        .trades-table tbody tr.trade-row:hover { background-color: rgba(0, 198, 255, 0.05); transform: translateY(-1px); }
        .trades-table tr.active-row { 
            background: linear-gradient(90deg, rgba(0, 198, 255, 0.1) 0%, rgba(10, 116, 218, 0.05) 100%) !important; 
            border-left: 3px solid var(--accent-cyan);
            box-shadow: 0 2px 8px rgba(0, 198, 255, 0.1);
        }
        .company-name { font-weight: 600; color: var(--text-primary); }
        .ticker { color: var(--accent-cyan); font-size: 0.9rem; font-weight: 500; }
        .insider-title { color: var(--text-tertiary); font-style: italic; }
        
        /* --- ENHANCED DROPDOWN DESIGN --- */
        .trade-details-row { 
            display: none; 
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        .trade-details-row.active { 
            display: table-row; 
            opacity: 1;
        }
        .trade-details-cell { 
            padding: 0 !important; 
            background: linear-gradient(135deg, rgba(16, 24, 44, 0.95) 0%, rgba(10, 15, 28, 0.95) 100%);
            border-left: 3px solid var(--accent-cyan);
            box-shadow: inset 0 0 20px rgba(0, 198, 255, 0.05);
        }
        .trade-details-content {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 2rem;
            animation: slideDownFade 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(0, 198, 255, 0.1);
            border-radius: 12px;
            margin: 1rem;
            backdrop-filter: blur(10px);
        }
        @media (max-width: 1200px) {
            .trade-details-content { 
                grid-template-columns: 1fr; 
                gap: 1.5rem;
            }
        }
        @keyframes slideDownFade { 
            0% { 
                opacity: 0; 
                transform: translateY(-30px) scale(0.95); 
            } 
            100% { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            } 
        }

        /* --- ADVANCED CHART CONTAINER --- */
        .chart-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .chart-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(0, 198, 255, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .chart-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-header .ticker-badge {
            background: var(--gradient-primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .tradingview-widget-container {
            width: 100%;
            height: 600px;
            background: var(--dark-bg);
            position: relative;
        }
        .widget-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .widget-loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* --- COMPANY PROFILE SIDEBAR --- */
        .info-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .insider-summary-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        .card-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(0, 198, 255, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-header h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .summary-stats {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .summary-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .summary-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
        }
        
        .summary-content {
            flex: 1;
        }
        
        .summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }
        
        .summary-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .profile-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            flex: 1;
        }
        
        .profile-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--card-bg) 0%, rgba(0, 198, 255, 0.1) 100%);
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-header h3 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .profile-content {
            padding: 0;
            height: 550px;
        }
        
        .fundamentals-widget {
            width: 100%;
            height: 100%;
            border-radius: 0;
            overflow: hidden;
            background: var(--dark-bg);
        }

        /* --- TOGGLE ICON ENHANCEMENT --- */
        .trade-toggle-icon { 
            margin-left: 0.5rem; 
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .trade-toggle-icon.rotated { 
            transform: rotate(180deg); 
            color: var(--accent-cyan);
        }
        .trade-row:hover .trade-toggle-icon {
            color: var(--accent-cyan);
            transform: translateX(2px);
        }
        .trade-row.active-row:hover .trade-toggle-icon.rotated {
            transform: rotate(180deg) translateX(-2px);
        }

        /* --- SKELETON LOADER --- */
        .skeleton-loader { 
            background: linear-gradient(90deg, var(--card-bg) 25%, var(--text-tertiary) 50%, var(--card-bg) 75%); 
            background-size: 200% 100%; 
            animation: loading 1.5s infinite; 
            border-radius: 4px; 
            color: transparent !important; 
        }
        .skeleton-row td > div { height: 20px; width: 80%; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .feed-container { overflow-x: auto; }

        /* --- REFINED DATE DISPLAY --- */
        .date-cell { width: 120px; }
        .date-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .date-icon-display {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-weight: 700;
            width: 60px;
            flex-shrink: 0;
            padding: 4px 0;
        }
        .date-icon-month { display: block; font-size: 0.7rem; color: var(--accent-cyan); text-transform: uppercase; letter-spacing: 0.5px; }
        .date-icon-day { display: block; font-size: 1.5rem; line-height: 1.2; color: var(--text-primary); }
        .date-time {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 6px;
            font-style: italic;
        }

        /* --- LOCKED DASHBOARD VIEW --- */
        .locked-dashboard { position: relative; border: 1px solid var(--border-color); border-radius: 16px; overflow: hidden; }
        .locked-content { filter: blur(8px); pointer-events: none; }
        .lock-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 15, 28, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 2rem; }
        .lock-overlay i { font-size: 4rem; color: var(--warning-yellow); margin-bottom: 1.5rem; }
        .lock-overlay h2 { font-size: 2rem; margin-bottom: 1rem; }
        .lock-overlay p { color: var(--text-secondary); margin-bottom: 2rem; max-width: 400px; }
        
        /* --- DISCLAIMER --- */
        .disclaimer { text-align: center; padding: 2rem; font-size: 0.8rem; color: var(--text-tertiary); border-top: 1px solid var(--border-color); margin-top: 4rem; }

        /* --- DEBUG PANEL --- */
        .debug-panel { position: fixed; bottom: 20px; right: 20px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; max-width: 300px; font-size: 0.8rem; z-index: 1000; }
        .debug-panel.hidden { display: none; }
        .debug-toggle { position: fixed; bottom: 20px; right: 20px; background: var(--primary-blue); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 1001; }
    </style>
</head>
<body>

    <div class="bg-animation"></div>

    <!-- Debug Toggle -->
    <button class="debug-toggle" onclick="toggleDebug()" title="Toggle Debug Panel">
        <i class="fas fa-bug"></i>
    </button>

    <!-- Debug Panel -->
    <div class="debug-panel hidden" id="debugPanel">
        <h4>Debug Info</h4>
        <div id="debugInfo">Loading...</div>
        <button class="btn btn-secondary" style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem;" onclick="refreshDebugInfo()">Refresh</button>
    </div>

    <!-- Auth & Processing Modals -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal" id="authModal">
            <h2 id="authTitle">Sign In</h2>
            <form class="auth-form" id="authForm">
                <div class="form-group"> <input type="email" id="email" class="input-field" required placeholder="your@email.com"> </div>
                <div class="form-group"> <input type="password" id="password" class="input-field" required placeholder="••••••••"> </div>
                <div class="status-message error hidden" id="authError"></div>
                <button type="submit" class="btn btn-primary" id="authSubmit">Sign In</button>
            </form>
            <div class="auth-toggle"> <span id="authToggleText">Don't have an account?</span> <a href="#" id="authToggleLink">Sign Up</a> </div>
        </div>
    </div>
    
    <div class="auth-overlay hidden" id="processingOverlay">
        <div class="auth-modal" style="text-align: center;">
            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: var(--accent-cyan); margin-bottom: 1.5rem;"></i>
            <h2>Finalizing Your Subscription</h2>
            <p class="text-secondary">Please wait a moment while we activate your account...</p>
            <div id="processingProgress" style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-tertiary);"></div>
        </div>
    </div>

    <header class="page-header">
        <div class="logo">DarkHorse</div>
        <div class="user-controls">
            <div id="loggedOutView"> <button class="btn btn-primary" onclick="showAuthModal(false)">Sign In</button> </div>
            <div id="loggedInView" class="hidden"> <span class="user-email" id="userEmailDisplay"></span> <button class="btn btn-secondary" onclick="signOut()">Sign Out</button> </div>
        </div>
    </header>

    <main>
        <!-- Pricing Section -->
        <section id="pricingSection" class="container">
            <h1>Get Insider Trading Alerts, Instantly.</h1>
            <p class="subtitle">Stop guessing. Start receiving real-time notifications when CEOs, CFOs, and other top executives make significant stock purchases.</p>
            <div class="pricing-grid">
                <div class="pricing-card">
                    <h3>Basic</h3> <p class="plan-desc">Essential email alerts for the casual investor.</p>
                    <div class="price">$3.99<span class="period">/month</span></div>
                    <ul class="features-list">
                        <li><i class="fas fa-check-circle"></i> Real-time email reports</li>
                        <li><i class="fas fa-check-circle"></i> Up to 4 trade alerts per week</li>
                        <li><i class="fas fa-lock"></i> Locked Insider Feed</li>
                    </ul>
                    <button class="btn btn-secondary plan-button" onclick="selectPlan('price_1Rg9zaP1BWtn2d85l7ENCAmm', 'basic')" disabled>Choose Basic</button>
                </div>
                <div class="pricing-card recommended">
                    <div class="recommended-badge">RECOMMENDED</div>
                    <h3>Professional</h3> <p class="plan-desc">For the serious investor who needs every edge.</p>
                    <div class="price">$8.99<span class="period">/month</span></div>
                    <ul class="features-list">
                        <li><i class="fas fa-check-circle"></i> Real-time SMS & Email alerts</li>
                        <li><i class="fas fa-check-circle"></i> <strong>Unlimited</strong> trade alerts</li>
                        <li><i class="fas fa-check-circle"></i> Full customization options</li>
                        <li><i class="fas fa-check-circle"></i> Live dashboard of all trades</li>
                        <li><i class="fas fa-check-circle"></i> Priority support</li>
                    </ul>
                    <button class="btn btn-primary plan-button" onclick="selectPlan('price_1RgA04P1BWtn2d850aqHB5UE', 'professional')" disabled>Choose Professional</button>
                </div>
                <div class="pricing-card">
                    <h3>Advanced</h3> <p class="plan-desc">More alerts and customization with SMS.</p>
                    <div class="price">$5.99<span class="period">/month</span></div>
                    <ul class="features-list">
                        <li><i class="fas fa-check-circle"></i> Real-time SMS & Email alerts</li>
                        <li><i class="fas fa-check-circle"></i> Up to 7 trade alerts per week</li>
                        <li><i class="fas fa-check-circle"></i> Customize notification channels</li>
                        <li><i class="fas fa-check-circle"></i> Live dashboard of all trades</li>
                    </ul>
                    <button class="btn btn-secondary plan-button" onclick="selectPlan('price_1Rg9zsP1BWtn2d85oZ3gjpQe', 'advanced')" disabled>Choose Advanced</button>
                </div>
            </div>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboardSection" class="container hidden">
            <div class="dashboard-header">
                <h1 id="dashboard-title">Insider Trades Feed</h1>
                <div class="dashboard-tabs">
                    <button class="tab-btn active" data-tab="feed">Feed</button>
                    <button class="tab-btn" data-tab="settings">Settings</button>
                    <button class="tab-btn hidden" id="upgrade-tab-btn" onclick="scrollToPricing()">Upgrade Plan</button>
                </div>
            </div>

            <div id="tab-content-feed" class="tab-content active"></div>
            <div id="tab-content-settings" class="tab-content">
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3><i class="fas fa-bell"></i> Notification Settings</h3>
                        <div class="settings-group">
                            <label>Channels</label>
                            <div class="switch-group"><span>Email Alerts</span> <label class="switch"><input type="checkbox" id="emailToggle"><span class="slider"></span></label></div>
                            <div class="switch-group" style="margin-top:0.5rem;"><span>SMS Alerts</span> <label class="switch"><input type="checkbox" id="smsToggle"><span class="slider"></span></label></div>
                        </div>
                        <div class="settings-group">
                            <label>Timing</label>
                            <div class="switch-group"><span>Real-Time</span> <label class="switch"><input type="radio" name="timing" value="realtime"><span class="slider"></span></label></div>
                            <div class="switch-group" style="margin-top:0.5rem;"><span>Daily Summary</span> <label class="switch"><input type="radio" name="timing" value="summary"><span class="slider"></span></label></div>
                            <input type="time" id="summaryTime" class="input-field hidden" style="margin-top: 0.5rem;">
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3><i class="fas fa-filter"></i> Alert Filters</h3>
                        <div class="settings-group">
                            <label for="stockPrice">Stock Price (at least) <span class="recommended-tag">Recommended: $3+</span></label>
                            <input type="range" id="stockPrice" min="0" max="100" value="3">
                            <div id="stockPriceValue" class="text-secondary" style="text-align:right;">$3.00</div>
                        </div>
                        <div class="settings-group">
                            <label for="tradeValue">Trade Value (at least)</label>
                            <input type="range" id="tradeValue" min="0" max="1000000" step="10000" value="0">
                            <div id="tradeValueValue" class="text-secondary" style="text-align:right;">Any</div>
                        </div>
                        <div class="settings-group">
                            <label>Insider Title <span class="recommended-tag">Recommended: CEO/CFO</span></label>
                            <div class="multi-select-group">
                                <label><input type="checkbox" name="insiderTitle" value="CEO" hidden><span>CEO</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="CFO" hidden><span>CFO</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="Director" hidden><span>Director</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="Officer" hidden><span>Officer</span></label>
                                <label><input type="checkbox" name="insiderTitle" value="President" hidden><span>President</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="save-settings-container">
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </section>
    </main>

    <footer class="disclaimer">
        <p>Disclaimer: DarkHorse is not a registered investment advisor. The information provided is for informational purposes only and does not constitute financial, investment, or other professional advice. All trading involves risk. Past performance is not indicative of future results.</p>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQY_Q9NBc3hmd44QhovkytcXRyzvV4Ips",
            authDomain: "darkhorsetrades-bd89e.firebaseapp.com",
            projectId: "darkhorsetrades-bd89e",
            storageBucket: "darkhorsetrades-bd89e.appspot.com",
            messagingSenderId: "528610189023",
            appId: "1:528610189023:web:1f8741bfb0f8635bf9d36a"
        };
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51RXnm1P1BWtn2d85f5PQ79tdyvhapp0rYDo0yDoH7SVWyWpyLdW4F5oX2RmKQ6KGZEJOXCRoU5WWEVOJTMJ8Y86P001uNGik7B';
        const SERVER_URL = 'https://darkhorse-backend.onrender.com';
        const RENDER_DATA_URL = 'https://insider-trading-api.onrender.com/api/insiders';

        // --- INITIALIZATION ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        // --- DOM Elements ---
        const authOverlay = document.getElementById('authOverlay'), authModal = document.getElementById('authModal'), authForm = document.getElementById('authForm'), authError = document.getElementById('authError'), authSubmit = document.getElementById('authSubmit'), authToggleLink = document.getElementById('authToggleLink'), authTitle = document.getElementById('authTitle'), authToggleText = document.getElementById('authToggleText');
        const processingOverlay = document.getElementById('processingOverlay'), processingProgress = document.getElementById('processingProgress');
        const loggedOutView = document.getElementById('loggedOutView'), loggedInView = document.getElementById('loggedInView'), userEmailDisplay = document.getElementById('userEmailDisplay');
        const pricingSection = document.getElementById('pricingSection'), dashboardSection = document.getElementById('dashboardSection');
        const feedTabContent = document.getElementById('tab-content-feed'), upgradeTabBtn = document.getElementById('upgrade-tab-btn'), dashboardTitle = document.getElementById('dashboard-title');
        const tabs = document.querySelectorAll('.tab-btn'), tabContents = document.querySelectorAll('.tab-content');

        // --- App State ---
        let appState = {
            currentUser: null,
            userProfile: null,
            isSignUp: false,
            unsubscribeUserProfile: null,
            activeTradeDetails: null,
            pollingInterval: null,
            debugMode: false,
            loadedWidgets: new Set()
        };

        // --- DEBUG FUNCTIONS ---
        window.toggleDebug = () => {
            appState.debugMode = !appState.debugMode;
            const debugPanel = document.getElementById('debugPanel');
            debugPanel.classList.toggle('hidden', !appState.debugMode);
            if (appState.debugMode) refreshDebugInfo();
        };

        window.refreshDebugInfo = async () => {
            const debugInfo = document.getElementById('debugInfo');
            const info = {
                'User': appState.currentUser ? `${appState.currentUser.uid} (${appState.currentUser.email})` : 'Not logged in',
                'Profile': appState.userProfile ? `Plan: ${appState.userProfile.subscription?.planId || 'none'}, Status: ${appState.userProfile.subscription?.status || 'none'}` : 'No profile',
                'Server Health': 'Checking...',
                'Data API': 'Checking...'
            };

            debugInfo.innerHTML = Object.entries(info).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');

            try {
                const response = await fetch(`${SERVER_URL}/health`);
                info['Server Health'] = response.ok ? '✅ OK' : '❌ Error';
            } catch (error) {
                info['Server Health'] = '❌ Unreachable';
            }

            try {
                const response = await fetchWithCORS(RENDER_DATA_URL);
                info['Data API'] = response.ok ? '✅ OK' : '❌ Error';
            } catch (error) {
                info['Data API'] = '❌ CORS/Unreachable';
            }

            debugInfo.innerHTML = Object.entries(info).map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`).join('');
        };

        // --- ENHANCED LOGGING ---
        const log = (level, message, data = null) => {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] ${level.toUpperCase()}: ${message}`, data || '');
            if (appState.debugMode) {
                refreshDebugInfo();
            }
        };

        // --- CORS-AWARE FETCH FUNCTION ---
        async function fetchWithCORS(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response;
            } catch (error) {
                log('error', 'CORS fetch failed', { url, error: error.message });
                throw error;
            }
        }

        // --- AUTHENTICATION & PAGE LOAD ---
        auth.onAuthStateChanged(user => {
            appState.currentUser = user;
            const planButtons = document.querySelectorAll('.plan-button');
            if (user) {
                log('info', 'User authenticated', { uid: user.uid, email: user.email });
                handleUserLogin();
                planButtons.forEach(button => button.disabled = false);
            } else {
                log('info', 'User logged out');
                handleUserLogout();
                planButtons.forEach(button => button.disabled = true);
            }
            handlePostPaymentRedirect();
        });

        function handlePostPaymentRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('success')) {
                log('info', 'Post-payment redirect detected, starting subscription polling');
                processingOverlay.classList.remove('hidden');
                processingOverlay.classList.add('show');
                window.history.replaceState(null, '', window.location.pathname);
                
                let attempts = 0;
                const maxAttempts = 30; 
                if (appState.pollingInterval) clearInterval(appState.pollingInterval);
                
                appState.pollingInterval = setInterval(async () => {
                    attempts++;
                    const remainingAttempts = maxAttempts - attempts;
                    processingProgress.textContent = `Checking subscription status... (${remainingAttempts} attempts remaining)`;
                    
                    if (appState.currentUser) {
                        try {
                            const userDoc = await db.collection('users').doc(appState.currentUser.uid).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                if (userData.subscription && userData.subscription.status === 'active') {
                                    log('success', 'Subscription activated successfully');
                                    clearInterval(appState.pollingInterval);
                                    appState.pollingInterval = null;
                                    appState.userProfile = { uid: userDoc.id, ...userData };
                                    processingOverlay.classList.remove('show');
                                    processingOverlay.classList.add('hidden');
                                    updateDashboardView();
                                    return;
                                }
                            }
                        } catch (error) {
                            log('error', 'Error checking subscription status', error);
                        }
                    }
                    if (attempts >= maxAttempts) {
                        log('error', 'Subscription polling timeout');
                        clearInterval(appState.pollingInterval);
                        appState.pollingInterval = null;
                        processingOverlay.classList.remove('show');
                        processingOverlay.classList.add('hidden');
                        displayMessage('Subscription activation is taking longer than expected. Please refresh the page or contact support if the issue persists.', 'error');
                    }
                }, 2000);
            }
            if (urlParams.has('canceled')) {
                log('info', 'Payment canceled');
                displayMessage('Your payment was canceled. You can choose a plan at any time.', 'info');
                window.history.replaceState(null, '', window.location.pathname);
            }
        }

        function displayMessage(message, type = 'info') {
            const messageBox = document.createElement('div');
            messageBox.className = `status-message ${type}`;
            messageBox.textContent = message;
            messageBox.style.position = 'fixed';
            messageBox.style.top = '20px';
            messageBox.style.left = '50%';
            messageBox.style.transform = 'translateX(-50%)';
            messageBox.style.zIndex = '10000';
            messageBox.style.padding = '15px 25px';
            messageBox.style.borderRadius = '8px';
            messageBox.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
            messageBox.style.transition = 'opacity 0.5s ease-in-out';
            messageBox.style.opacity = '0';
            document.body.appendChild(messageBox);

            setTimeout(() => { messageBox.style.opacity = '1'; }, 10);
            setTimeout(() => {
                messageBox.style.opacity = '0';
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 5000);
        }

        function handleUserLogin() {
            loggedInView.classList.remove('hidden');
            loggedOutView.classList.add('hidden');
            userEmailDisplay.textContent = appState.currentUser.email;

            const userDocRef = db.collection('users').doc(appState.currentUser.uid);
            appState.unsubscribeUserProfile = userDocRef.onSnapshot(async (doc) => {
                if (doc.exists) {
                    appState.userProfile = { uid: doc.id, ...doc.data() };
                } else {
                    log('info', 'Creating initial user profile');
                    await createInitialUserProfile(userDocRef);
                }
                updateDashboardView();
            }, (error) => {
                log('error', 'Error listening to user profile', error);
            });
        }

        async function createInitialUserProfile(userDocRef) {
            const initialProfile = {
                email: appState.currentUser.email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                subscription: { planId: null, status: 'none' },
                settings: {
                    notifyByEmail: true, notifyBySms: false, timing: 'realtime', summaryTime: '17:00',
                    filters: { stockPrice: 3, tradeValue: 0, titles: ['CEO', 'CFO'] }
                }
            };
            try {
                await userDocRef.set(initialProfile);
                appState.userProfile = initialProfile;
            } catch (error) {
                log('error', 'Error creating user profile', error);
            }
        }

        function handleUserLogout() {
            if (appState.unsubscribeUserProfile) appState.unsubscribeUserProfile();
            if (appState.pollingInterval) clearInterval(appState.pollingInterval);
            appState.userProfile = null;
            loggedInView.classList.add('hidden');
            loggedOutView.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
            pricingSection.classList.remove('hidden');
        }

        window.signOut = () => auth.signOut();
        
        window.showAuthModal = (signUp) => {
            appState.isSignUp = signUp;
            authOverlay.classList.add('show');
            authTitle.textContent = signUp ? 'Create an Account' : 'Sign In';
            authSubmit.textContent = signUp ? 'Sign Up' : 'Sign In';
            authToggleText.textContent = signUp ? "Already have an account?" : "Don't have an account?";
            authToggleLink.textContent = signUp ? 'Sign In' : 'Sign Up';
            authError.classList.add('hidden');
        };
        
        window.closeAuthModal = () => authOverlay.classList.remove('show');
        authOverlay.addEventListener('click', (e) => { if (e.target === authOverlay) closeAuthModal(); });
        authToggleLink.addEventListener('click', (e) => { e.preventDefault(); showAuthModal(!appState.isSignUp); });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authSubmit.disabled = true;
            authSubmit.textContent = 'Processing...';
            authError.classList.add('hidden');

            try {
                if (appState.isSignUp) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
                closeAuthModal();
            } catch (error) {
                authError.textContent = error.message;
                authError.classList.remove('hidden');
            } finally {
                authSubmit.disabled = false;
                authSubmit.textContent = appState.isSignUp ? 'Sign Up' : 'Sign In';
            }
        });

        window.selectPlan = async (priceId, planName) => {
            if (!appState.currentUser) { 
                showAuthModal(false); 
                return; 
            }
            
            const checkoutButton = event.target;
            const originalText = checkoutButton.textContent;
            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Redirecting...';

            try {
                const userDoc = await db.collection('users').doc(appState.currentUser.uid).get();
                if (!userDoc.exists) throw new Error('User profile not found. Please refresh and try again.');

                const response = await fetch(`${SERVER_URL}/create-checkout-session`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        priceId: priceId,
                        planName: planName,
                        userId: appState.currentUser.uid,
                        userEmail: appState.currentUser.email
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }

                const { sessionId } = await response.json();
                if (!sessionId) throw new Error('No session ID received from server');
                
                const { error } = await stripe.redirectToCheckout({ sessionId });
                if (error) throw error;

            } catch (error) {
                log('error', 'Checkout session creation failed', error);
                displayMessage(`Could not initiate payment: ${error.message}`, 'error');
                checkoutButton.disabled = false;
                checkoutButton.textContent = originalText;
            }
        };

        // --- VIEW MANAGEMENT & RENDERING ---
        function updateDashboardView() {
            if (!appState.userProfile) return;

            const { subscription } = appState.userProfile;
            if (subscription && subscription.status === 'active') {
                processingOverlay.classList.remove('show');
                processingOverlay.classList.add('hidden');
                pricingSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');

                const { planId } = subscription;
                upgradeTabBtn.classList.toggle('hidden', planId !== 'basic');
                
                if (planId === 'basic') {
                    dashboardTitle.textContent = "Dashboard Preview";
                    renderLockedDashboard();
                } else {
                    dashboardTitle.textContent = "Insider Trades Feed";
                    renderFullDashboard();
                }
                populateSettingsView();
            } else {
                if (!processingOverlay.classList.contains('show')) {
                    dashboardSection.classList.add('hidden');
                    pricingSection.classList.remove('hidden');
                }
            }
        }

        function renderLockedDashboard() {
            feedTabContent.innerHTML = `
                <div class="locked-dashboard">
                    <div class="locked-content">
                        <div class="feed-container">
                        <table class="trades-table">
                            <thead><tr><th>Filing Date</th><th>Trade Date</th><th>Company</th><th>Insider</th><th>Title</th><th>Price</th><th>Quantity</th><th>ΔOwn</th><th>Value</th></tr></thead>
                            <tbody>
                                <tr><td>...</td><td>...</td><td>Cyberdyne Systems<br><small>CDYNE</small></td><td>Miles Dyson</td><td class="insider-title">CTO</td><td>$45.25</td><td>99,500</td><td>+15.2%</td><td>$4,502,500</td></tr>
                                <tr><td>...</td><td>...</td><td>Stark Industries<br><small>STRK</small></td><td>Pepper Potts</td><td class="insider-title">CEO</td><td>$8.59</td><td>99,400</td><td>+8.3%</td><td>$853,900</td></tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="lock-overlay">
                        <i class="fas fa-lock"></i><h2>Full Feed Locked</h2>
                        <p>Upgrade to an Advanced or Professional plan to unlock the live feed, real-time alerts, and advanced charts.</p>
                        <button class="btn btn-primary" onclick="scrollToPricing()">Upgrade Your Plan</button>
                    </div>
                </div>`;
        }
        
        async function renderFullDashboard() {
            feedTabContent.innerHTML = `
                <div class="feed-container">
                    <table class="trades-table">
                        <thead><tr><th>Filing Date</th><th>Trade Date</th><th>Company</th><th>Insider</th><th>Title</th><th>Price</th><th>Quantity</th><th>ΔOwn</th><th>Value</th><th></th></tr></thead>
                        <tbody id="trades-tbody"></tbody>
                    </table>
                </div>`;
            await populateTradesTable();
        }

        // Helper function to format dates
        function formatDateCell(dateString, showTime) {
            if (!dateString || typeof dateString !== 'string') {
                return '<td class="date-cell"><div class="date-wrapper">N/A</div></td>';
            }

            const parts = dateString.split(' ');
            const datePart = parts[0];
            const timePart = parts.length > 1 ? parts[1] : null;

            const date = new Date(datePart);
            if (isNaN(date.getTime())) {
                return `<td class="date-cell"><div class="date-wrapper">${dateString}</div></td>`;
            }

            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const month = monthNames[date.getMonth()];
            const day = date.getDate();
            
            let timeHtml = '';
            if (showTime && timePart) {
                let [hours, minutes] = timePart.split(':');
                let period = 'AM';
                hours = parseInt(hours, 10);
                if (hours >= 12) {
                    period = 'PM';
                    if (hours > 12) hours -= 12;
                }
                if (hours === 0) hours = 12;
                timeHtml = `<div class="date-time">${hours}:${minutes} ${period}</div>`;
            }

            return `
                <td class="date-cell">
                    <div class="date-wrapper">
                        <div class="date-icon-display">
                            <span class="date-icon-month">${month}</span>
                            <span class="date-icon-day">${day}</span>
                        </div>
                        ${timeHtml}
                    </div>
                </td>
            `;
        }

        async function populateTradesTable() {
            const tbody = document.getElementById('trades-tbody');
            if (!tbody) return;
            
            log('debug', 'Populating trades table');
            tbody.innerHTML = '';
            for(let i=0; i<5; i++) { tbody.innerHTML += `<tr class="skeleton-row"><td colspan="10"><div class="skeleton-loader" style="width: 100%; height: 24px;"></div></td></tr>`; }

            try {
                log('debug', 'Attempting to fetch data from API', { url: RENDER_DATA_URL });
                const response = await fetchWithCORS(RENDER_DATA_URL);
                const trades = await response.json();
                
                log('success', 'Raw trades data received', { count: trades.length, sample: trades[0] });
                
                // Clean and normalize the data from the CSV structure
                const cleanedTrades = trades.map(trade => {
                    const cleaned = {};
                    
                    // Handle different possible column name variations and clean them
                    for (const [key, value] of Object.entries(trade)) {
                        let cleanKey = key.replace(/\u00A0/g, ' ').replace(/\s+/g, ' ').trim();
                        
                        // Normalize key names to match expected structure
                        if (cleanKey.toLowerCase().includes('filing') && cleanKey.toLowerCase().includes('date')) {
                            cleaned['Filing Date'] = value;
                        } else if (cleanKey.toLowerCase().includes('trade') && cleanKey.toLowerCase().includes('date')) {
                            cleaned['Trade Date'] = value;
                        } else if (cleanKey.toLowerCase().includes('company') && cleanKey.toLowerCase().includes('name')) {
                            cleaned['Company Name'] = value;
                        } else if (cleanKey.toLowerCase() === 'ticker') {
                            cleaned['Ticker'] = value;
                        } else if (cleanKey.toLowerCase().includes('insider') && cleanKey.toLowerCase().includes('name')) {
                            cleaned['Insider Name'] = value;
                        } else if (cleanKey.toLowerCase() === 'title') {
                            cleaned['Title'] = value;
                        } else if (cleanKey.toLowerCase().includes('trade') && cleanKey.toLowerCase().includes('type')) {
                            cleaned['Trade Type'] = value;
                        } else if (cleanKey.toLowerCase() === 'price') {
                            cleaned['Price'] = value;
                        } else if (cleanKey.toLowerCase() === 'qty') {
                            cleaned['Qty'] = value;
                        } else if (cleanKey.toLowerCase() === 'owned') {
                            cleaned['Owned'] = value;
                        } else if (cleanKey.includes('Own') || cleanKey.includes('Δ') || cleanKey.includes('Delta')) {
                            cleaned['ΔOwn'] = value;
                        } else if (cleanKey.toLowerCase() === 'value') {
                            cleaned['Value'] = value;
                        } else {
                            // Keep other fields as-is
                            cleaned[cleanKey] = value;
                        }
                    }
                    
                    return cleaned;
                });

                // Filter for purchase trades only
                const purchasesTrades = cleanedTrades.filter(trade => {
                    const tradeType = (trade['Trade Type'] || '').toString().toLowerCase().trim();
                    return tradeType.includes('purchase') || tradeType.startsWith('p') || tradeType === 'p - purchase';
                });
                
                log('success', 'Trades data processed', { 
                    total: trades.length, 
                    purchases: purchasesTrades.length,
                    sampleCleaned: purchasesTrades[0]
                });
                
                tbody.innerHTML = '';
                if (purchasesTrades.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding: 2rem;">No insider purchases found.</td></tr>`;
                    return;
                }

                purchasesTrades.slice(0, 50).forEach(trade => {
                    const tradeId = `${trade.Ticker || 'UNKNOWN'}-${trade['Trade Date'] || Date.now()}`.replace(/[^a-zA-Z0-9]/g, '');
                    const row = document.createElement('tr');
                    row.className = 'trade-row';
                    row.dataset.ticker = trade.Ticker || 'UNKNOWN';
                    row.dataset.id = tradeId;
                    
                    const filingDateStr = trade['Filing Date'] || '';
                    const tradeDateStr = trade['Trade Date'] || '';
                    const companyName = trade['Company Name'] || 'Unknown Company';
                    const ticker = trade.Ticker || 'N/A';
                    const insiderName = trade['Insider Name'] || 'Unknown';
                    const title = trade.Title || 'N/A';
                    
                    // Clean and parse numeric values
                    const priceStr = (trade.Price || '0').toString().replace(/[$,]/g, '');
                    const price = parseFloat(priceStr) || 0;
                    
                    const qtyStr = (trade.Qty || '0').toString().replace(/[,]/g, '');
                    const qty = parseInt(qtyStr) || 0;
                    
                    const deltaOwn = trade['ΔOwn'] || trade['Î"Own'] || trade['Delta Own'] || 'N/A';
                    
                    const valueStr = (trade.Value || '0').toString().replace(/[$,]/g, '');
                    const value = parseInt(valueStr) || 0;
                    
                    const filingDateCell = formatDateCell(filingDateStr, true);
                    const tradeDateCell = formatDateCell(tradeDateStr, false);

                    row.innerHTML = `
                        ${filingDateCell}
                        ${tradeDateCell}
                        <td><div class="company-name">${companyName}</div><div class="ticker">${ticker}</div></td>
                        <td>${insiderName}</td>
                        <td class="insider-title">${title}</td>
                        <td>$${price.toFixed(2)}</td>
                        <td>${qty.toLocaleString()}</td>
                        <td>${deltaOwn}</td>
                        <td>$${value.toLocaleString()}</td>
                        <td><i class="fas fa-chevron-down trade-toggle-icon"></i></td>`;
                    
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'trade-details-row';
                    detailsRow.innerHTML = `<td colspan="10" class="trade-details-cell"><div class="trade-details-content" id="details-content-${tradeId}"></div></td>`;

                    tbody.appendChild(row);
                    tbody.appendChild(detailsRow);

                    row.addEventListener('click', () => toggleTradeDetails(row, detailsRow, ticker, companyName));
                });
            } catch (error) {
                log('error', 'Failed to fetch or process trades', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align:center; padding: 2rem; color: var(--error-red);">
                            <div>Could not load trades feed.</div>
                            <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                                Error: ${error.message}
                            </div>
                            <button class="btn btn-secondary" style="margin-top: 1rem; padding: 0.5rem 1rem;" onclick="location.reload()">Retry</button>
                        </td>
                    </tr>`;
            }
        }
        
        function toggleTradeDetails(row, detailsRow, ticker, companyName) {
            const rowId = row.dataset.id;
            const isActive = row.classList.contains('active-row');
            const toggleIcon = row.querySelector('.trade-toggle-icon');

            // Close any other open details row
            if (appState.activeTradeDetails && appState.activeTradeDetails !== rowId) {
                const oldActiveRow = document.querySelector(`.trade-row[data-id="${appState.activeTradeDetails}"]`);
                if (oldActiveRow) {
                    const oldDetailsRow = oldActiveRow.nextElementSibling;
                    const oldToggleIcon = oldActiveRow.querySelector('.trade-toggle-icon');
                    oldActiveRow.classList.remove('active-row');
                    if (oldDetailsRow) oldDetailsRow.classList.remove('active');
                    if (oldToggleIcon) oldToggleIcon.classList.remove('rotated');
                }
            }

            row.classList.toggle('active-row', !isActive);
            detailsRow.classList.toggle('active', !isActive);
            if (toggleIcon) toggleIcon.classList.toggle('rotated', !isActive);

            if (!isActive) {
                appState.activeTradeDetails = rowId;
                loadAdvancedTradingViewWidgets(ticker, companyName, `details-content-${rowId}`);
            } else {
                appState.activeTradeDetails = null;
            }
        }

        // --- ENHANCED TRADINGVIEW WIDGETS LOADING ---
        function loadAdvancedTradingViewWidgets(ticker, companyName, containerId) {
            const container = document.getElementById(containerId);
            if (!container || appState.loadedWidgets.has(containerId)) return;
            
            log('debug', 'Loading TradingView widgets', { ticker, companyName, containerId });
            
            // Mark as loaded to prevent duplicate loading
            appState.loadedWidgets.add(containerId);
            
            // Create the enhanced layout with insider trading summary
            container.innerHTML = `
                <div class="chart-section">
                    <div class="chart-header">
                        <h3>
                            <i class="fas fa-chart-line"></i>
                            Price Chart
                            <span class="ticker-badge">${ticker}</span>
                        </h3>
                    </div>
                    <div class="tradingview-widget-container" id="chart-${containerId}">
                        <div class="widget-loading">
                            <i class="fas fa-spinner"></i>
                            <div>Loading chart...</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <div class="insider-summary-card">
                        <div class="card-header">
                            <h4><i class="fas fa-users"></i> Insider Activity Summary</h4>
                        </div>
                        <div class="summary-stats">
                            <div class="summary-item">
                                <div class="summary-icon"><i class="fas fa-arrow-up"></i></div>
                                <div class="summary-content">
                                    <div class="summary-label">Recent Purchases</div>
                                    <div class="summary-value">View Live</div>
                                </div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-icon"><i class="fas fa-chart-trend-up"></i></div>
                                <div class="summary-content">
                                    <div class="summary-label">Insider Sentiment</div>
                                    <div class="summary-value">Bullish</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <div class="profile-header">
                            <h3>
                                <i class="fas fa-building"></i>
                                Company Profile
                            </h3>
                        </div>
                        <div class="profile-content">
                            <div class="fundamentals-widget" id="fundamentals-${containerId}">
                                <div class="widget-loading">
                                    <i class="fas fa-spinner"></i>
                                    <div>Loading company profile...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load TradingView script if not already loaded
            if (!window.TradingView) {
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://s3.tradingview.com/tv.js';
                script.async = true;
                script.onload = () => initializeWidgets(ticker, containerId);
                document.head.appendChild(script);
            } else {
                initializeWidgets(ticker, containerId);
            }
        }

        function initializeWidgets(ticker, containerId) {
            setTimeout(() => {
                try {
                    // Advanced Chart Widget (restored)
                    new TradingView.widget({
                        "autosize": true,
                        "symbol": ticker,
                        "interval": "D",
                        "timezone": "Etc/UTC",
                        "theme": "dark",
                        "style": "1",
                        "locale": "en",
                        "toolbar_bg": "#0a0f1c",
                        "enable_publishing": false,
                        "backgroundColor": "#0a0f1c",
                        "gridColor": "#1a1a1a",
                        "hide_side_toolbar": false,
                        "allow_symbol_change": true,
                        "details": true,
                        "hotlist": true,
                        "calendar": true,
                        "studies": [
                            "Volume@tv-basicstudies",
                            "MACD@tv-basicstudies"
                        ],
                        "container_id": `chart-${containerId}`,
                        "withdateranges": true,
                        "hide_top_toolbar": false,
                        "save_image": false,
                        "container": document.getElementById(`chart-${containerId}`)
                    });

                    // Company Profile Widget - Proper TradingView implementation
                    const profileContainer = document.getElementById(`fundamentals-${containerId}`);
                    if (profileContainer) {
                        // Clear the container
                        profileContainer.innerHTML = '';
                        
                        // Create the exact structure TradingView expects
                        const widgetHTML = `
                            <div class="tradingview-widget-container">
                                <div class="tradingview-widget-container__widget"></div>
                                <div class="tradingview-widget-copyright">
                                    <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                                        <span class="blue-text">Track all markets on TradingView</span>
                                    </a>
                                </div>
                            </div>
                        `;
                        
                        profileContainer.innerHTML = widgetHTML;
                        
                        // Create script with configuration inside
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-symbol-profile.js';
                        script.async = true;
                        
                        // The configuration goes INSIDE the script tag as text content
                        script.textContent = `
                        {
                            "symbol": "${ticker}",
                            "colorTheme": "dark",
                            "isTransparent": true,
                            "locale": "en",
                            "width": "100%",
                            "height": "550"
                        }`;
                        
                        // Append the script to the widget container
                        profileContainer.querySelector('.tradingview-widget-container').appendChild(script);
                    }

                    log('success', 'TradingView widgets loaded successfully', { ticker, containerId });
                } catch (error) {
                    log('error', 'Failed to load TradingView widgets', { ticker, containerId, error });
                    
                    // Show error message in containers
                    const chartContainer = document.getElementById(`chart-${containerId}`);
                    const fundamentalsContainer = document.getElementById(`fundamentals-${containerId}`);
                    
                    if (chartContainer) {
                        chartContainer.innerHTML = `
                            <div class="widget-loading">
                                <i class="fas fa-exclamation-triangle" style="color: var(--error-red);"></i>
                                <div>Failed to load chart for ` + ticker + `</div>
                            </div>`;
                    }
                    
                    if (fundamentalsContainer) {
                        fundamentalsContainer.innerHTML = `
                            <div class="widget-loading">
                                <i class="fas fa-exclamation-triangle" style="color: var(--error-red);"></i>
                                <div>Failed to load company data</div>
                            </div>`;
                    }
                }
            }, 500);
        }

        // --- SETTINGS MANAGEMENT ---
        function populateSettingsView() {
            if (!appState.userProfile || !appState.userProfile.settings) return;
            
            const { planId } = appState.userProfile.subscription;
            const { settings } = appState.userProfile;
            const isCustomizable = (planId === 'advanced' || planId === 'professional');
            
            document.querySelectorAll('.settings-card input, .settings-card button').forEach(el => el.disabled = !isCustomizable);
            document.querySelectorAll('.settings-card').forEach(el => el.style.opacity = isCustomizable ? '1' : '0.5');

            document.getElementById('emailToggle').checked = settings.notifyByEmail;
            document.getElementById('smsToggle').checked = settings.notifyBySms;
            document.querySelector(`input[name="timing"][value="${settings.timing}"]`).checked = true;
            document.getElementById('summaryTime').classList.toggle('hidden', settings.timing !== 'summary');
            document.getElementById('summaryTime').value = settings.summaryTime;

            const { stockPrice, tradeValue, titles } = settings.filters;
            document.getElementById('stockPrice').value = stockPrice;
            updateSliderValue('stockPriceValue', stockPrice, val => `$${parseFloat(val).toFixed(2)}` );
            document.getElementById('tradeValue').value = tradeValue;
            updateSliderValue('tradeValueValue', tradeValue, val => val > 0 ? `$${(val/1000).toLocaleString()}k` : 'Any');
            document.querySelectorAll('input[name="insiderTitle"]').forEach(el => {
                if (el.nextElementSibling) {
                    el.checked = titles.includes(el.value);
                    el.nextElementSibling.parentElement.style.background = el.checked ? 'var(--gradient-primary)' : 'rgba(0,0,0,0.2)';
                }
            });
        }

        window.saveSettings = async () => {
            const saveButton = event.target;
            const originalText = saveButton.textContent;
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';

            const settingsToSave = {
                notifyByEmail: document.getElementById('emailToggle').checked,
                notifyBySms: document.getElementById('smsToggle').checked,
                timing: document.querySelector('input[name="timing"]:checked').value,
                summaryTime: document.getElementById('summaryTime').value,
                filters: {
                    stockPrice: parseFloat(document.getElementById('stockPrice').value),
                    tradeValue: parseInt(document.getElementById('tradeValue').value),
                    titles: Array.from(document.querySelectorAll('input[name="insiderTitle"]:checked')).map(el => el.value)
                }
            };
            
            try {
                await db.collection('users').doc(appState.currentUser.uid).update({ settings: settingsToSave });
                displayMessage('Settings saved successfully!', 'success');
            } catch (error) {
                log('error', 'Failed to save settings', error);
                displayMessage("Failed to save settings. Please try again.", 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        };
        
        // --- EVENT LISTENERS ---
        tabs.forEach(tab => tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            tabContents.forEach(c => c.classList.toggle('active', c.id === `tab-content-${tab.dataset.tab}`));
        }));
        
        document.querySelectorAll('input[name="timing"]').forEach(el => {
            el.addEventListener('change', e => {
                document.getElementById('summaryTime').classList.toggle('hidden', e.target.value !== 'summary');
            });
        });
        
        document.querySelectorAll('input[name="insiderTitle"]').forEach(el => {
            el.addEventListener('change', e => {
                e.target.nextElementSibling.parentElement.style.background = e.target.checked ? 'var(--gradient-primary)' : 'rgba(0,0,0,0.2)';
            });
        });
        
        function updateSliderValue(elementId, value, formatter) { 
            document.getElementById(elementId).textContent = formatter(value); 
        }
        
        document.getElementById('stockPrice').addEventListener('input', e => updateSliderValue('stockPriceValue', e.target.value, val => `$${parseFloat(val).toFixed(2)}`));
        document.getElementById('tradeValue').addEventListener('input', e => updateSliderValue('tradeValueValue', e.target.value, val => val > 0 ? `$${(val/1000).toLocaleString()}k` : 'Any'));
        window.scrollToPricing = () => pricingSection.scrollIntoView({ behavior: 'smooth' });

        if (appState.debugMode) refreshDebugInfo();
    });
    </script>
</body>
</html>